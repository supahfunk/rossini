{"version":3,"sources":["docs/js/app.js"],"names":["angular","module","config","$httpProvider","$locationProvider","$routeProvider","html5Mode","hashPrefix","when","templateUrl","controller","otherwise","run","$rootScope","factory","SceneOptions","StepperService","DatGui","onOptionsChanged","params","step","stepper","getCurrentStep","colors","background","options","lines","overLines","camera","cameraHeight","targetHeight","circle","position","copy","$broadcast","onKeyDown","e","key","toLowerCase","ctrlKey","$","document","find","toggleClass","gui","dat","GUI","randomize","controllers","i","length","c","__min","value","__max","Math","random","setValue","updateDisplay","__color","r","floor","g","b","hex","__controllers","forEach","__folders","folder","saveJson","json","steps","map","item","THREE","Color","getHexString","console","log","downloadFile","closed","add","listen","onChange","circlePosition","addFolder","addColor","audio","element","window","on","a","createElement","body","appendChild","style","data","fileName","pretty","JSON","stringify","blob","Blob","type","url","URL","createObjectURL","href","download","click","revokeObjectURL","directive","$parse","$timeout","restrict","link","scope","attributes","onTap","navTo","onTouchStart","off","onMouseDown","removeListeners","$on","model","Init","scrollbar","Scrollbar","init","native","$watch","contentEl","offsetHeight","height","update","speed","damping","overscrollDamping","thumbMinSize","continuousScrolling","alwaysShowTracks","setTimeout","app","unSlick","hasClass","slick","onSlick","arrows","dots","fade","infinite","draggable","asNavFor","useBackground","cssEase","initialSlide","current","showLetters","letters","TweenMax","staggerTo","delay","y","x","ease","Power3","easeInOut","className","onComplete","addClass","hideLetters","removeClass","onInit","$root","onBeforeChange","event","currentSlide","nextSlide","slicking","previous","onAfterChange","onWheel","deltaX","deltaY","preventDefault","$watchCollection","slickTunnel","items","$scope","index","lazyLoad","slickBackgrounds","splitText","nodes","childNodes","Array","prototype","slice","call","html","rows","filter","node","nodeType","text","trim","textContent","nodeName","push","innerHTML","row","appendTo","el","words","split","w","word","l","letter","from","to","onChangeYears","updateYear","yearFrom","parseInt","years","yearTo","easing","easeOut","TweenLite","roundProps","onUpdate","newValue","oldValue","$route","$routeParams","$ngSilentLocation","MotionService","updateParallax","motion","loop","requestAnimationFrame","$q","State","AudioService","AssetService","doPreload","onprogress","progress","all","getAudioPromise","getAssetPromise","then","onReady","error","state","paths","indexOf","preload","texture","scene","$$route","originalPath","openDetail","ready","silent","detailUrl","detail","active","closeDetail","objects","assets","busy","yearsKey","$location","$http","addMenu","menu","parse","parent","String","nav","updateStepper","navStep","lvl","itemToggle","closeNav","submenu","isNavActive","itemOpen","closing","opening","opened","itemClose","o","get","response","this","errors","isReady","idle","isBusy","isError","isErroring","isSuccess","isSuccessing","button","enabled","success","bind","DELAY","errorMessage","submitClass","successing","errorring","labels","addons","showCompletionState","defaults","erroring","extend","label","classes","pulse","flash","service","_onprogress","path","loaded","total","deferred","defer","load","resolve","reject","promise","xhr","XMLHttpRequest","responseType","open","onload","image","Image","src","images","onerror","send","AudioSound","$options","volume","sound","offset","addAnalyserNode","addGainNode","ctx","decodeAudioData","buffer","buffers","AudioContext","webkitAudioContext","createGain","createGainNode","gain","analyser","createAnalyser","fftSize","bands","Uint8Array","frequencyBinCount","connectNodes","source","p","connect","destination","disconnect","updateBuffer","getBuffer","createBufferSource","getSource","playing","stop","noteOff","play","startTime","currentTime","start","noteOn","getByteFrequencyData","setPath","setVolume","getData","setStep","pause","toggle","isActive","isPlaying","Date","now","set","z","addListeners","DeviceOrientationEvent","addEventListener","onDeviceOrientation","beta","gamma","min","$sce","values","pow","titleTrusted","trustAsHtml","title","contrast","getContrast","Vector3","clearTweens","tweens","pop","kill","tweenTo","duration","callback","Power2","setTweens","setBackground","getStepAtIndex","max","next","top","width","css","-webkit-transform","-moz-transform","-ms-transform","transform","color","getPerlinNoise","size","perlin","ImprovedNoise","quality","j","abs","noise","t","lerp","grad","hash","h","u","v","floorX","floorY","floorZ","X","Y","Z","xMinus1","yMinus1","zMinus1","A","AA","AB","B","BA","BB","getRandomRange","allowNegatives","n","device","mobile","parallax","mouse","translate","friction","translateYear","-webit-transform","translateSlick","cos","sin","getObjectRibbon","object","remove","updateRibbon","s","cpow","tpow","mod","cameraSpline","getPointAt","target","lookAt","resolution","Vector2","innerWidth","innerHeight","material","MeshLineMaterial","lineWidth","opacity","transparent","depthTest","sizeAttenuation","near","far","prev","points","ribbon","fill","spline","CatmullRomCurve3","geometry","Geometry","vertices","getPoints","line","MeshLine","setGeometry","Mesh","getCanvasMaterial","half","canvas","context","getContext","beginPath","arc","PI","clip","MeshBasicMaterial","Texture","img","drawImage","needsUpdate","getObjectCircles","adding","removing","tween","getLine1","addPoints","points1","useMeshLines","meshLine","meshLineGeometries1","meshLines1","materialLine1","LineLoop","material1","clone","group1","getLine2","points2","meshLineGeometries2","meshLines2","materialLine2","material2","group2","pn","ratio","degrees","radians","radius","increment","sincos","base","updateLine","audioStrength","noiseStrength","circularStrength","noiseMap","noiseMap1","noiseMap2","totalPow","aia","aib","audioPow","nd","nia","nib","noisePow","linePow","ln","shadowPlane","scale","verticesNeedUpdate","updateCircle","lines1","lines2","rotation","dummy","dummyMobilePosition","LineBasicMaterial","Object3D","PlaneGeometry","shadowMaterial","plane","circles","render","renderer","stats","begin","end","w2","h2","gradient","createRadialGradient","addColorStop","fillStyle","fillRect","Scene","PerspectiveCamera","WebGLRenderer","alpha","antialias","logarithmicDepthBuffer","setClearColor","setSize","sortObjects","Stats","domElement","dom","onWindowResize","aspect","updateProjectionMatrix","handleMouseMove","halfW","halfH","clientX","clientY","Number","isIOS","test","navigator","userAgent","MSStream","isMobileAndTabled","check","substr","vendor","opera","constant","ios"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app', ['ngSilent', 'ngRoute', 'ngSanitize', 'jsonFormatter']);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.config(['$httpProvider', function($httpProvider) {\n        // $httpProvider.defaults.withCredentials = true;\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.config(['$locationProvider', '$routeProvider', function($locationProvider, $routeProvider) {\n\n        // HTML5 MODE url writing method (false: #/anchor/use, true: /html5/url/use)\n        $locationProvider.html5Mode(false);\n        $locationProvider.hashPrefix('');\n\n        $routeProvider.when('/test', {\n            templateUrl: function() {\n                return 'partials/test.html';\n            },\n            controller: 'TestCtrl',\n\n        }).when('/years', {\n            templateUrl: function() {\n                return 'partials/years.html';\n            },\n            controller: 'YearsCtrl',\n\n        }).when('/years/:yearsKey', {\n            templateUrl: function() {\n                return 'partials/years.html';\n            },\n            controller: 'YearsCtrl',\n\n        }).when('/years/:yearsKey/detail', {\n            templateUrl: function() {\n                return 'partials/years.html';\n            },\n            controller: 'YearsCtrl',\n\n        });\n\n        $routeProvider.otherwise('/years');\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.run(['$rootScope', function($rootScope) {\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.factory('DatGui', ['$rootScope', 'SceneOptions', 'StepperService', function($rootScope, SceneOptions, StepperService) {\n\n        var downloadFile = function downloadFile() {\n            var a = document.createElement(\"a\");\n            document.body.appendChild(a);\n            a.style = \"display: none\";\n            return function(data, fileName, json, pretty) {\n                if (json) {\n                    if (pretty) {\n                        data = JSON.stringify(data, null, 2); // spacing level = 2\n                    } else {\n                        data = JSON.stringify(data);\n                    }\n                }\n                var blob = new Blob([data], { type: \"octet/stream\" }),\n                    url = window.URL.createObjectURL(blob);\n                a.href = url;\n                a.download = fileName;\n                a.click();\n                window.URL.revokeObjectURL(url);\n            };\n        }();\n\n        function DatGui() {\n            var options = SceneOptions;\n            var stepper = StepperService;\n            var gui = new dat.GUI();\n\n            options.randomize = function() {\n                // console.log(gui);\n                function randomize(controllers) {\n                    for (var i = 0; i < controllers.length; i++) {\n                        var c = controllers[i];\n                        if (c.__min) {\n                            var value = c.__min + (c.__max - c.__min) * Math.random();\n                            // options[c.property] = value;\n                            c.setValue(value);\n                            c.updateDisplay();\n                        }\n                        if (c.__color) {\n                            c.__color.r = Math.floor(Math.random() * 255);\n                            c.__color.g = Math.floor(Math.random() * 255);\n                            c.__color.b = Math.floor(Math.random() * 255);\n                            c.updateDisplay();\n                            c.setValue(c.__color.hex);\n                        }\n                    }\n                }\n                randomize(gui.__controllers);\n                angular.forEach(gui.__folders, function(folder) {\n                    randomize(folder.__controllers);\n                });\n                // console.log(options.circle.position);\n                // console.log(stepper.step.circle.position);\n            };\n\n            options.saveJson = function() {\n                var json = stepper.steps.map(function(item) {\n                    item = angular.copy(item);\n                    var colors = {\n                        background: '#' + new THREE.Color(item.colors.background).getHexString(),\n                        lines: '#' + new THREE.Color(item.colors.lines).getHexString(),\n                        overLines: '#' + new THREE.Color(item.colors.overLines).getHexString(),\n                    }\n                    item.colors = colors;\n                    return item;\n                });\n                console.log('saveJson', json);\n                downloadFile(json, 'rossini.js', true, true);\n            };\n\n            function onOptionsChanged(params) {\n                var step = stepper.getCurrentStep();\n                step.colors.background = options.colors.background;\n                step.colors.lines = options.colors.lines;\n                step.colors.overLines = options.colors.overLines;\n                step.camera.cameraHeight = options.camera.cameraHeight;\n                step.camera.targetHeight = options.camera.targetHeight;\n                step.circle.position.copy(options.circle.position);\n                $rootScope.$broadcast('onOptionsChanged');\n            }\n\n            gui.closed = true;\n            gui.add(options.camera, 'cameraHeight', -10.0, 30.0).listen().onChange(onOptionsChanged);\n            gui.add(options.camera, 'targetHeight', -10.0, 30.0).listen().onChange(onOptionsChanged);\n            var circlePosition = gui.addFolder('circlePosition');\n            circlePosition.add(options.circle.position, 'x', -300, 300).listen().onChange(onOptionsChanged);\n            circlePosition.add(options.circle.position, 'y', -300, 300).listen().onChange(onOptionsChanged);\n            circlePosition.add(options.circle.position, 'z', -300, 300).listen().onChange(onOptionsChanged);\n            var colors = gui.addFolder('colors');\n            colors.addColor(options.colors, 'background').listen().onChange(onOptionsChanged);\n            colors.addColor(options.colors, 'lines').listen().onChange(onOptionsChanged);\n            colors.addColor(options.colors, 'overLines').listen().onChange(onOptionsChanged);\n            gui.add(options.audio, 'volume', 0.01, 1.0).onChange(onOptionsChanged);\n            gui.add(options, 'audioStrength', 10, 100).onChange(onOptionsChanged);\n            gui.add(options, 'noiseStrength', 10, 100).onChange(onOptionsChanged);\n            gui.add(options, 'circularStrength', 0.01, 0.90).onChange(onOptionsChanged);\n            gui.add(options, 'randomize');\n            gui.add(options, 'saveJson');\n\n            angular.element(window).on('keydown', onKeyDown);\n\n            function onKeyDown(e) {\n                var key = e.key.toLowerCase();\n                if (key === 'a' && e.ctrlKey) {\n                    $(document).find('body').toggleClass('gui-active');\n                }\n            }\n\n            return gui;\n        }\n\n        return DatGui;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('navTo', ['$parse', '$timeout', function($parse, $timeout) {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function onTap(e) {\n                    console.log('navTo.onTap', attributes.navTo);\n                    $timeout(function() {\n                        var callback = $parse(attributes.navTo);\n                        callback(scope);\n                    });\n                }\n\n                function onTouchStart(e) {\n                    onTap();\n                    element\n                        .off('mousedown', onMouseDown);\n                    // e.preventDefault();\n                    // return false;\n                }\n\n                function onMouseDown(e) {\n                    onTap();\n                    element\n                        .off('touchstart', onTouchStart);\n                    // e.preventDefault();\n                    // return false;\n                }\n\n                function addListeners() {\n                    element\n                        .on('touchstart', onTouchStart)\n                        .on('mousedown', onMouseDown);\n                }\n\n                function removeListeners() {\n                    element\n                        .off('touchstart', onTouchStart)\n                        .off('mousedown', onMouseDown);\n                }\n\n                addListeners();\n\n                scope.$on('$destroy', function() {\n                    removeListeners();\n                });\n\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('scrollbar', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes, model) {\n                var native = element[0];\n                var options = {\n                    speed: 1,\n                    damping: 0.1,\n                    overscrollDamping: 1.0,\n                    thumbMinSize: 20,\n                    continuousScrolling: true,\n                    alwaysShowTracks: false\n                };\n\n                function Init() {\n                    var scrollbar = Scrollbar.init(native, options);\n                    // console.log(scrollbar);\n                    scope.$watch(scrollbar.contentEl.offsetHeight, function(height) {\n                        scrollbar.update();\n                    });\n                }\n\n                setTimeout(Init, 100);\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('slickTunnel', ['$timeout', 'StepperService', 'SceneOptions', function($timeout, StepperService, SceneOptions) {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                var options = SceneOptions;\n                var stepper = StepperService;\n\n                function unSlick() {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('unslick');\n                    }\n                }\n\n                function onSlick() {\n                    unSlick();\n                    element.slick({\n                        arrows: false,\n                        dots: false,\n                        fade: true,\n                        speed: 1100,\n                        infinite: false,\n                        draggable: false,\n                        asNavFor: options.useBackground ? '.tunnel-bg' : null,\n                        cssEase: 'cubic-bezier(0.7, 0, 0.3, 1)',\n                        initialSlide: stepper.current\n                    });\n                }\n\n                function showLetters() {\n                    var letters = $('.slick-active .splitted-letter');\n                    TweenMax.staggerTo(letters, 1, {\n                        delay: 0.2,\n                        y: 0,\n                        x: 0,\n                        ease: Power3.easeInOut,\n                        className: '+=viewed',\n                        onComplete: function() {\n                            $('.slick-active .cta').addClass('active');\n                        }\n                    }, 0.009);\n                }\n\n                function hideLetters() {\n                    var letters = $('.slick-active .splitted-letter');\n                    TweenMax.staggerTo(letters, 1, {\n                        delay: 0,\n                        y: 100,\n                        x: 50,\n                        ease: Power3.easeInOut,\n                        className: '-=viewed'\n                    }, 0.009);\n                    $('.slick-active .cta').removeClass('active');\n                }\n\n                function onInit() {\n                    // console.log('onInit');\n                    setTimeout(function() {\n                        showLetters();\n                    }, 500);\n                    scope.$root.$broadcast('onSlickInit');\n                }\n\n                function onBeforeChange(event, slick, currentSlide, nextSlide) {\n                    stepper.slicking = true;\n                    hideLetters();\n                    // console.log('onBeforeChange');               \n                    scope.$root.$broadcast('onSlickBeforeChange', { current: nextSlide, previous: currentSlide });\n                }\n\n                function onAfterChange(event, slick, currentSlide) {\n                    stepper.slicking = false;\n                    showLetters();\n                    // console.log('onAfterChange');\n                    scope.$root.$broadcast('onSlickAfterChange', { current: currentSlide });\n                }\n\n                function onWheel(e) {\n                    if (stepper.slicking) {\n                        return;\n                    }\n                    if (element.hasClass('slick-initialized')) {\n                        if (e.deltaX > 0 || e.deltaY < 0) {\n                            element.slick('slickNext');\n                        } else if (e.deltaX < 0 || e.deltaY > 0) {\n                            if (stepper.current == 1) {\n                                return;\n                            }\n                            element.slick('slickPrev');\n                        }\n                    }\n                    e.preventDefault();\n                }\n\n                function addListeners() {\n                    element\n                        .on('init', onInit)\n                        .on('beforeChange', onBeforeChange)\n                        .on('afterChange', onAfterChange)\n                        .on('mousewheel', onWheel);\n                }\n\n                function removeListeners() {\n                    element\n                        .off('init', onInit)\n                        .off('beforeChange', onBeforeChange)\n                        .off('afterChange', onAfterChange)\n                        .off('mousewheel', onWheel);\n                }\n\n                addListeners();\n\n                scope.$watchCollection(attributes.slickTunnel, function(items) {\n                    if (items && items.length) {\n                        onSlick();\n                    }\n                });\n\n                scope.$on('onGoStep', function($scope, index) {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('slickGoTo', index);\n                    }\n                });\n\n                scope.$on('$destroy', function() {\n                    removeListeners();\n                    unSlick();\n                });\n            }\n        };\n    }]);\n\n    app.directive('slickBackgrounds', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function unSlick() {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('unslick');\n                    }\n                }\n\n                function onSlick() {\n                    unSlick();\n                    element.slick({\n                        arrows: false,\n                        dots: false,\n                        fade: true,\n                        speed: 1100,\n                        infinite: false,\n                        lazyLoad: 'ondemand',\n                        cssEase: 'cubic-bezier(0.7, 0, 0.3, 1)'\n                    });\n                }\n\n                scope.$watchCollection(attributes.slickBackgrounds, function(items) {\n                    if (items && items.length) {\n                        setTimeout(onSlick, 1)\n                    }\n                });\n\n                scope.$on('$destroy', function() {\n                    unSlick();\n                });\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('splitText', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function splitText() {\n\n                    var nodes = element[0].childNodes;\n                    nodes = Array.prototype.slice.call(nodes, 0);\n\n                    element.html('').addClass('active');\n\n                    var rows = [\n                        []\n                    ];\n\n                    nodes.filter(function(node) {\n                        return node.nodeType === 3 || node.nodeType === 1;\n                    }).map(function(node) {\n                        if (node.nodeType === 3) {\n                            node = { text: $.trim(node.textContent), element: 'span' };\n                        } else {\n                            if (node.nodeName.toLowerCase() === 'br') {\n                                rows.push([]);\n                                return;\n                            }\n                            node = { text: $.trim(node.innerHTML), element: node.nodeName };\n                        }\n                        if (node.text !== '') {\n                            rows[rows.length - 1].push(node);\n                        }\n                    });\n\n                    for (var r = 0; r < rows.length; r++) {\n                        /* Riga */\n                        // console.log('riga ' + r, rows[r]);\n                        var row = rows[r];\n                        $('<div class=\"splitted-row\"></div>').appendTo(element);\n\n                        /* Elemento */\n                        for (var e = 0; e < row.length; e++) {\n                            var el = row[e];\n                            var type = el.element.toLowerCase();\n                            var text = el.text;\n                            // console.log('\\telemento ' + e, type, text);\n\n                            /* Parola */\n                            var words = text.split(' ');\n                            for (var w = 0; w < words.length; w++) {\n                                // console.log('\\t\\tword ' + w, words[w]);\n                                $('<' + type + ' class=\"splitted-word\"></' + type + '>').appendTo($('.splitted-row:last'), element);\n\n                                /* Lettera */\n                                var word = words[w];\n                                var letters = word.split('');\n                                for (var l = 0; l < letters.length; l++) {\n                                    // console.log('\\t\\t\\tlettera' + l, letters[l]);\n                                    var letter = letters[l];\n                                    $('<span class=\"splitted-letter\" data-content=\"' + letter + '\">' + letter + '</span>').appendTo($('.splitted-word:last'), element);\n                                }\n                                $('<span class=\"splitted-space\">&nbsp;</span>').appendTo($('.splitted-word:last'), element);\n                            }\n                        }\n                    }\n                }\n\n                setTimeout(function() {\n                    splitText();\n                }, 1);\n\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('yearsFrom', [function() {\n        return {\n            restrict: 'A',\n            scope: {\n                from: '=yearsFrom',\n                to: '=yearsTo',\n            },\n            link: function(scope, element, attributes) {\n                function onChangeYears() {\n                    // console.log('onChangeYears', scope.from, scope.to);\n\n                    var yearFrom = element.find('.from'),\n                        yearTo = element.find('.to'),\n                        time = 2,\n                        easing = Power3.easeOut,\n                        years = {\n                            from: yearFrom.html(),\n                            to: yearTo.html()\n                        };\n\n                    if (scope.to) {\n                        element.removeClass('one-year');\n                        TweenLite.to(years, time, { to: scope.to, roundProps: 'year', onUpdate: updateYear, ease: easing });\n                    } else {\n                        element.addClass('one-year');\n                        TweenLite.to(years, time, { to: scope.from, roundProps: 'year', onUpdate: updateYear, ease: easing });\n                    }\n\n                    TweenLite.to(years, time, { from: scope.from, roundProps: 'year', onUpdate: updateYear, ease: easing });\n\n                    function updateYear() {\n                        yearFrom.html(parseInt(years.from));\n                        yearTo.html(parseInt(years.to));\n                    }\n                }\n\n                scope.$watch('from', function(newValue, oldValue) {\n                    if (newValue) {\n                        onChangeYears();\n                    }\n                });\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.controller('TestCtrl', ['$scope', '$route', '$routeParams', '$ngSilentLocation', 'MotionService', '$timeout', function($scope, $route, $routeParams, $ngSilentLocation, MotionService, $timeout) {\n\n        var motion = MotionService;\n        motion.init();\n\n        function updateParallax() {\n            $timeout(function() {\n                motion.update();\n            });\n        }\n\n        function loop() {\n            updateParallax();\n            requestAnimationFrame(loop);\n        }\n\n        loop();\n\n        $scope.motion = motion;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.controller('YearsCtrl', ['$scope', '$timeout', '$route', '$routeParams', '$ngSilentLocation', '$q', 'State', 'SceneOptions', 'StepperService', 'AudioService', 'AssetService', 'DatGui', function($scope, $timeout, $route, $routeParams, $ngSilentLocation, $q, State, SceneOptions, StepperService, AudioService, AssetService, DatGui) {\n\n        var state = new State();\n\n        var scene = {\n            objects: {},\n            options: SceneOptions,\n            stepper: StepperService,\n            assets: AssetService,\n        };\n\n        var objects = scene.objects;\n        var options = scene.options;\n        var stepper = scene.stepper;\n        var assets = scene.assets;\n\n        state.busy();\n        stepper.init($routeParams.yearsKey).then(function() {\n            if (options.preload) {\n                doPreload();\n            } else {\n                onReady();\n            }\n        });\n\n        function doPreload() {\n            function onprogress(item) {\n                $timeout(function() {\n                    $scope.progress = item;\n                    // console.log('onprogress', item);\n                });\n            }\n            $q.all([\n                getAudioPromise(onprogress),\n                getAssetPromise(onprogress),\n\n            ]).then(function() {\n                onReady();\n\n            }, function(error) {\n                console.log('YearsCtrl.error', error);\n                state.error(error);\n\n            });\n        }\n\n        function getAudioPromise(onprogress) {\n            var paths = [];\n            stepper.steps.filter(function(item) {\n                if (item.audio && paths.indexOf(item.audio.url) == -1) {\n                    paths.push(item.audio.url);\n                }\n            });\n            // console.log('YearsCtrl.getAudioPromise', paths);\n            return AudioService.preload(paths, onprogress);\n        }\n\n        function getAssetPromise(onprogress) {\n            var paths = [];\n            stepper.steps.filter(function(item) {\n                if (item.circle && paths.indexOf(item.circle.texture) == -1) {\n                    paths.push(item.circle.texture);\n                }\n            });\n            // console.log('YearsCtrl.getAssetPromise', paths);\n            return AssetService.preload(paths, onprogress);\n        }\n\n        function onReady() {\n            $scope.stepper = stepper;\n            $scope.scene = scene;\n            $scope.audio = AudioService;\n            if ($route.current.$$route.originalPath.indexOf('/detail') !== -1) {\n                $timeout(function() {\n                    openDetail();\n                });\n            }\n            // preloadAudio();\n            var gui = new DatGui();\n            state.ready();\n        }\n\n        var detail = {};\n\n        function openDetail() {\n            $ngSilentLocation.silent(stepper.step.detailUrl);\n            detail.active = true;\n            return false;\n        }\n\n        function closeDetail() {\n            $ngSilentLocation.silent(stepper.step.url);\n            detail.active = false;\n            return false;\n        }\n\n        $scope.state = state;\n        $scope.detail = detail;\n        $scope.openDetail = openDetail;\n        $scope.closeDetail = closeDetail;\n\n        $scope.$on('onStepChanged', function() {\n            $ngSilentLocation.silent(stepper.step.url);\n        });\n\n        // console.log('YearsCtrl', $route, $routeParams);\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.controller('RootCtrl', ['$scope', '$route', '$location', '$http', '$timeout', '$ngSilentLocation', 'StepperService', function($scope, $route, $location, $http, $timeout, $ngSilentLocation, StepperService) {\n\n        $http.get('json/menu-rossini.js').then(function(response) {\n            addMenu(response.data);\n\n        }, function(error) {\n            console.log('RootCtrl.error', error);\n\n        });\n\n        function addMenu(menu) {\n\n            function parse(items, parent) {\n                if (items) {\n                    angular.forEach(items, function(item) {\n                        item.parent = parent;\n                        if (item.years) {\n                            item.years.key = String(item.years.to ? item.years.from + '-' + item.years.to : item.years.from); // da riattivare !!!\n                            item.url = '/years/' + item.years.key;\n                            // item.detailUrl = item.url + '/detail';\n                        }\n                        parse(item.items, item);\n                    });\n                }\n            }\n            parse(menu);\n\n            $scope.menu = menu;\n\n            $timeout(function() {\n                nav();\n            }, 100);\n        }\n\n        function updateStepper(item) {\n            var stepper = StepperService;\n            var steps = stepper.steps;\n            var index = -1;\n            angular.forEach(steps, function(step, i) {\n                if (step.url === item.url) {\n                    index = i;\n                }\n            });\n            if (index !== -1) {\n                stepper.navStep(index);\n                $ngSilentLocation.silent(item.url);\n            }\n        }\n\n        function navTo(item, lvl) {\n            itemToggle(item);\n            if (item.url) {\n                if (item.url.indexOf('/years') !== -1 && $route.current.$$route.originalPath.indexOf('/years') !== -1) {\n                    closeNav();\n                    $timeout(function() {\n                        updateStepper(item);\n                    }, 1000);\n\n                } else {\n                    // $location.path(item.url);\n                }\n                $scope.submenu = null;\n                console.log('RootCtrl.navTo', item.url);\n            } else if (lvl === 2 && item.items) {\n                if ($scope.submenu) {\n                    $timeout(function() {\n                        $scope.submenu = item;\n                    }, 1000);\n                } else {\n                    $scope.submenu = item;\n                }\n            }\n        }\n\n        function isNavActive(item) {\n            return false;\n        }\n\n        function itemOpen(item) {\n            item.active = true;\n            item.closed = item.closing = false;\n            item.opening = true;\n            $timeout(function() {\n                item.opening = false;\n                item.opened = true;\n            });\n        }\n\n        function itemClose(item) {\n            item.active = false;\n            item.opened = item.opening = false;\n            item.closing = true;\n            $timeout(function() {\n                item.closing = false;\n                item.closed = true;\n            });\n        }\n\n        function itemToggle(item) {\n            item.active = !item.active;\n            if (item.active) {\n                if (item.parent) {\n                    item.parent.items.filter(function(o) {\n                        if (o !== item) {\n                            itemClose(o);\n                        }\n                    });\n                }\n                itemOpen(item);\n            } else {\n                itemClose(item);\n            }\n        }\n\n        $scope.navTo = navTo;\n        $scope.isNavActive = isNavActive;\n\n    }]);\n\n}());\n/* global angular */\r\n\r\n(function() {\r\n  \"use strict\";\r\n\r\n  var app = angular.module('app');\r\n\r\n  app.factory('State', ['$timeout', function($timeout) {\r\n    var DELAY = 2000;\r\n\r\n    function State() {\r\n        this.errors = [];\r\n      this.isReady = false;\r\n      this.idle();\r\n    }\r\n    State.prototype = {\r\n      idle: idle,\r\n      busy: busy,\r\n      enabled: enabled,\r\n      error: error,\r\n      ready: ready,\r\n      success: success,\r\n      errorMessage: errorMessage,\r\n      submitClass: submitClass,\r\n      labels: labels,\r\n      classes: classes\r\n    };\r\n    return State;\r\n\r\n    function idle() {\r\n      this.isBusy = false;\r\n      this.isError = false;\r\n      this.isErroring = false;\r\n      this.isSuccess = false;\r\n      this.isSuccessing = false;\r\n      this.button = null;\r\n      //this.errors = [];\r\n    }\r\n\r\n    function enabled() {\r\n      return !this.isBusy && !this.isErroring && !this.isSuccessing;\r\n    }\r\n\r\n    function busy() {\r\n      if (!this.isBusy) {\r\n        this.isBusy = true;\r\n        this.isError = false;\r\n        this.isErroring = false;\r\n        this.isSuccess = false;\r\n        this.isSuccessing = false;\r\n        this.errors = [];\r\n        // console.log('State.busy', this);\r\n        return true;\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    function success() {\r\n      this.isBusy = false;\r\n      this.isError = false;\r\n      this.isErroring = false;\r\n      this.isSuccess = true;\r\n      this.isSuccessing = true;\r\n      this.errors = [];        \r\n      $timeout(function () {\r\n      \tthis.isSuccessing = false;\r\n      }.bind(this), DELAY);      \r\n    }\r\n\r\n    function error(error) {\r\n      this.isBusy = false;\r\n      this.isError = true;\r\n      this.isErroring = true;\r\n      this.isSuccess = false;\r\n      this.isSuccessing = false;\r\n      this.errors.push(error);\r\n      $timeout(function () {\r\n          this.isErroring = false;          \r\n      }.bind(this), DELAY);\r\n    }\r\n\r\n    function ready() {\r\n    \tthis.idle();\r\n        this.isReady = true;\r\n    }\r\n\r\n    function errorMessage() {\r\n        //return this.isError ? this.errors[this.errors.length - 1] : null;\r\n        return this.errors.length > 0 ? this.errors[this.errors.length - 1] : null;\r\n    }\r\n\r\n    function submitClass() {\r\n      return {\r\n        busy: this.isBusy,\r\n        ready: this.isReady,\r\n        successing: this.isSuccessing,\r\n        success: this.isSuccess,\r\n        errorring: this.isErroring,\r\n        error: this.isError,\r\n      };\r\n    }\r\n\r\n    function labels(addons, showCompletionState) {\r\n        var scope = this;\r\n        var defaults = {\r\n            ready: 'submit',\r\n            busy: 'sending',\r\n            error: 'error',\r\n            erroring: 'erroring',\r\n            success: 'success',\r\n            successing: 'successing',\r\n        };\r\n        if (addons) {\r\n            angular.extend(defaults, addons);\r\n        }\r\n        var label = defaults.ready;\r\n        if (this.isBusy) {\r\n            label = defaults.busy;\r\n        } else if (this.isSuccessing) {\r\n            label = defaults.successing;\r\n        } else if (this.isErroring) {\r\n            label = defaults.erroring;\r\n        }\r\n        if (showCompletionState) {\r\n            if (this.isSuccess) {\r\n                label = defaults.success;\r\n            } else if (this.isError) {\r\n                label = defaults.error;\r\n            }\r\n        }\r\n        return label;\r\n    }\r\n\r\n    function classes(addons) {\r\n        var scope = this,\r\n            classes = null;\r\n        classes = {\r\n            ready: scope.isReady,\r\n            busy: scope.isBusy,\r\n            successing: scope.isSuccessing,\r\n            success: scope.isSuccess,\r\n            errorring: scope.isErroring,\r\n            error: scope.isError,\r\n            pulse: scope.isBusy,\r\n            flash: scope.isErroring || scope.isSuccessing,\r\n        };\r\n        if (addons) {\r\n            angular.forEach(addons, function (value, key) {\r\n                classes[value] = classes[key];\r\n            });\r\n        }\r\n        // console.log('stateClass', classes);\r\n        return classes;\r\n    }\r\n\r\n  }]);\r\n\r\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.service('AssetService', ['$q', function($q) {\n\n        var service = this;\n        var images = {};\n\n        function preload(items, onprogress) {\n            var deferred = $q.defer();\n            var paths = {};\n            var progress = {\n                loaded: 0,\n                total: 0,\n            };\n\n            function _onprogress(progress) {\n                paths[progress.path] = progress;\n                var p = 0;\n                angular.forEach(paths, function(item) {\n                    progress.loaded += item.loaded;\n                    progress.total += item.total;\n                });\n                progress.progress = progress.loaded / progress.total;\n                onprogress(progress);\n            }\n            $q.all(\n                items.map(function(path) {\n                    return load(path, _onprogress);\n                })\n            ).then(function() {\n                progress.loaded = progress.total;\n                progress.progress = 1;\n                onprogress(progress);\n                deferred.resolve();\n            }, function(error) {\n                console.log('AssetService.preload.error', error);\n                deferred.reject(error);\n            });\n            return deferred.promise;\n        }\n\n        function load(path, onprogress) {\n            var deferred = $q.defer();\n            var progress = {\n                path: path,\n                loaded: 0,\n                total: 1,\n            };\n            var xhr = new XMLHttpRequest();\n            xhr.responseType = \"arraybuffer\";\n            xhr.open(\"GET\", path, true);\n            xhr.onload = function() {\n                var blob = new Blob([xhr.response]);\n                var image = new Image();\n                image.src = window.URL.createObjectURL(blob);\n                images[path] = image;\n                deferred.resolve(image);\n            };\n            xhr.onerror = function(error) {\n                console.log('AssetService.xhr.onerror', error);\n                deferred.reject(error);\n            };\n            if (onprogress) {\n                xhr.onprogress = function(e) {\n                    progress.loaded = e.loaded;\n                    progress.total = e.total;\n                    progress.progress = e.loaded / e.total;\n                    onprogress(progress);\n                };\n                /*\n                xhr.onloadstart = function(e) {\n                    progress.loaded = 0;\n                    progress.total = 1;\n                    progress.progress = 0;\n                    onprogress(progress);\n                };\n                xhr.onloadend = function(e) {\n                    progress.loaded = progress.total;\n                    progress.progress = 1;\n                    onprogress(progress);\n                };\n                */\n            }\n            xhr.send();\n            return deferred.promise;\n        }\n\n        this.load = load;\n        this.preload = preload;\n        this.images = images;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.factory('AudioSound', ['$q', 'SceneOptions', function($q, SceneOptions) {\n\n        window.AudioContext = window.AudioContext || window.webkitAudioContext;\n\n        var ctx = new AudioContext();\n        var buffers = {};\n\n        function AudioSound($options) {\n            var options = {\n                volume: 0.85,\n                loop: false,\n            };\n            if ($options) {\n                angular.extend(options, $options);\n            }\n            var sound = this;\n            sound.options = options;\n            sound.offset = options.offset || 0;\n            this.addAnalyserNode();\n            this.addGainNode();\n        }\n\n        AudioSound.prototype = {\n            nodes: {},\n            addGainNode: function() {\n                var sound = this;\n                var node = ctx.createGain ? ctx.createGain() : ctx.createGainNode();\n                node.gain.value = sound.options.volume;\n                // node.connect(ctx.destination);\n                sound.nodes.gain = node;\n            },\n            addAnalyserNode: function() {\n                var sound = this;\n                if (sound.options.analyser) {\n                    var node = ctx.createAnalyser();\n                    node.fftSize = SceneOptions.audio.bands * 2;\n                    sound.data = new Uint8Array(node.frequencyBinCount);\n                    sound.nodes.analyser = node;\n                }\n            },\n            connectNodes: function() {\n                var sound = this;\n                var source = sound.source;\n                for (var p in sound.nodes) {\n                    var node = sound.nodes[p];\n                    source.connect(node);\n                    if (p === 'gain') {\n                        node.connect(ctx.destination);\n                    }\n                }\n                // console.log('connectNodes', sound.nodes);\n            },\n            disconnect: function() {\n                var sound = this;\n                var source = sound.source;\n                if (source) {\n                    for (var p in sound.nodes) {\n                        var node = sound.nodes[p];\n                        if (p === 'gain') {\n                            node.disconnect(ctx.destination);\n                        }\n                        source.disconnect(sound.nodes[p]);\n                        // console.log('AudioSound.disconnect', p);\n                    }\n                    // source.diconnect();\n                    sound.source = null;\n                }\n            },\n            updateBuffer: function() {\n                var deferred = $q.defer();\n                var sound = this;\n                var source = sound.source;\n                sound.getBuffer().then(function(buffer) {\n                    if (source) {\n                        source.buffer = buffer;\n                    } else {\n                        source = ctx.createBufferSource();\n                        source.buffer = buffer;\n                        sound.source = source;\n                        sound.connectNodes();\n                    }\n                    deferred.resolve(source);\n                }, function(error) {\n                    deferred.reject(error);\n                });\n                return deferred.promise;\n            },\n            getBuffer: function() {\n                // console.log('AudioSound.getBuffer');\n                var deferred = $q.defer();\n                var sound = this;\n                var path = sound.path;\n                var buffer = buffers[path];\n                if (buffer) {\n                    deferred.resolve(buffer);\n                } else {\n                    AudioSound.load(path).then(function(buffer) {\n                        if (sound.path === path) {\n                            deferred.resolve(buffer);\n                        }\n                    }, function(error) {\n                        deferred.reject(error);\n                    });\n                }\n                return deferred.promise;\n            },\n            getSource: function() {\n                var deferred = $q.defer();\n                var sound = this;\n                var source = sound.source;\n                // console.log('AudioSound.getSource', source);\n                if (source) {\n                    deferred.resolve(source);\n                } else {\n                    sound.getBuffer().then(function(buffer) {\n                        var source = null;\n                        if (sound.playing) {\n                            source = sound.source;\n                            if (source) {\n                                if (typeof source.stop === 'function') {\n                                    source.stop(0); // when\n                                } else {\n                                    source.noteOff(0); // when\n                                }\n                                sound.disconnect();\n                            }\n                        }\n                        source = ctx.createBufferSource();\n                        source.buffer = buffer;\n                        sound.source = source;\n                        sound.connectNodes();\n                        deferred.resolve(source);\n                    }, function(error) {\n                        deferred.reject(error);\n                    });\n                }\n                return deferred.promise;\n            },\n            play: function() {\n                var sound = this;\n                if (!sound.playing) {\n                    var options = sound.options;\n                    sound.getSource().then(function(source) {\n                        // sound.stop();\n                        sound.startTime = ctx.currentTime;\n                        source.loop = options.loop;\n                        if (typeof source.start === 'function') {\n                            source.start(0, sound.offset); // when, offset, duration\n                        } else {\n                            source.noteOn(0, sound.offset); // when, offset, duration\n                        }\n                        sound.playing = true;\n                    });\n                }\n                // ctx.resume(); ???\n                // console.log('AudioSound.play');\n            },\n            stop: function() {\n                var sound = this;\n                if (sound.playing) {\n                    var source = sound.source;\n                    if (source) {\n                        sound.offset += sound.startTime ? (ctx.currentTime - sound.startTime) : 0;\n                        // console.log(sound.offset);\n                        if (typeof source.stop === 'function') {\n                            source.stop(0); // when\n                        } else {\n                            source.noteOff(0); // when\n                        }\n                        sound.disconnect();\n                        sound.playing = false;\n                        // console.log('AudioSound.stop');\n                        // ctx.suspend(); ???\n                    }\n                }\n            },\n            update: function() {\n                var sound = this;\n                if (sound.nodes.analyser) {\n                    sound.nodes.analyser.getByteFrequencyData(sound.data);\n                }\n            },\n            setPath: function(path) {\n                var sound = this;\n                if (path && sound.path !== path) {\n                    sound.stop();\n                    sound.path = path;\n                    sound.offset = sound.options.offset || 0;\n                    console.log('AudioSound.setPath', path);\n                }\n            },\n            setVolume: function(volume) {\n                var sound = this;\n                if (volume !== sound.options.volume) {\n                    sound.options.volume = volume;\n                    sound.nodes.gain.gain.value = volume;\n                }\n            }\n        };\n\n        function load(path, onprogress) {\n            var deferred = $q.defer();\n            var progress = {\n                path: path,\n                loaded: 0,\n                total: 1,\n            };\n            var xhr = new XMLHttpRequest();\n            xhr.responseType = \"arraybuffer\";\n            xhr.open(\"GET\", path, true);\n            xhr.onload = function() {\n                ctx.decodeAudioData(xhr.response, function(buffer) {\n                    if (!buffer) {\n                        console.log('AudioSound.load.decodeAudioData.error', path);\n                        deferred.reject('AudioSound.load.decodeAudioData.error');\n                        return;\n                    }\n                    // console.log('AudioSound.decodeAudioData', path);\n                    buffers[path] = buffer;\n                    deferred.resolve(buffer);\n                });\n            };\n            xhr.onerror = function(error) {\n                console.log('AudioManager.xhr.onerror', error);\n                deferred.reject(error);\n            };\n            if (onprogress) {\n                xhr.onprogress = function(e) {\n                    progress.loaded = e.loaded;\n                    progress.total = e.total;\n                    progress.progress = e.loaded / e.total;\n                    onprogress(progress);\n                };\n                /*\n                xhr.onloadstart = function(e) {\n                    progress.loaded = 0;\n                    progress.total = 1;\n                    progress.progress = 0;\n                    onprogress(progress);\n                };\n                xhr.onloadend = function(e) {\n                    progress.loaded = progress.total;\n                    progress.progress = 1;\n                    onprogress(progress);\n                };\n                */\n            }\n            xhr.send();\n            return deferred.promise;\n        }\n\n        AudioSound.load = load;\n\n        return AudioSound;\n    }]);\n\n    app.service('AudioService', ['$rootScope', '$timeout', '$q', '$http', 'AudioSound', 'SceneOptions', 'StepperService', function($rootScope, $timeout, $q, $http, AudioSound, SceneOptions, StepperService) {\n\n        var service = this;\n        var options = SceneOptions;\n        var stepper = StepperService;\n        var sound = new AudioSound({\n            analyser: true,\n        });\n\n        function getData() {\n            return sound.data;\n        }\n\n        function setStep() {\n            var step = stepper.getCurrentStep();\n            setPath(step.audio ? step.audio.url : null);\n        }\n\n        function setPath(path) {\n            sound.setPath(path);\n            play();\n        }\n\n        function setVolume(volume) {\n            sound.setVolume(volume);\n        }\n\n        function update() {\n            if (service.active && sound.playing) {\n                sound.setVolume(options.audio.volume);\n                sound.update();\n            }\n        }\n\n        function play() {\n            if (service.active && sound.path && !sound.playing) {\n                sound.play();\n            }\n        }\n\n        function pause() {\n            if (sound.playing) {\n                sound.stop();\n            }\n        }\n\n        function toggle() {\n            service.active = !service.active;\n            if (service.active) {\n                play();\n            } else {\n                pause();\n            }\n        }\n\n        function isActive() {\n            return service.active && sound.playing;\n        }\n\n        function isPlaying() {\n            return sound.playing;\n        }\n\n        function preload(items, onprogress) {\n            var deferred = $q.defer();\n            var paths = {};\n            var progress = {\n                loaded: 0,\n                total: 0,\n            };\n\n            function _onprogress(progress) {\n                paths[progress.path] = progress;\n                var p = 0;\n                angular.forEach(paths, function(item) {\n                    progress.loaded += item.loaded;\n                    progress.total += item.total;\n                });\n                progress.progress = progress.loaded / progress.total;\n                onprogress(progress);\n            }\n            $q.all(\n                items.map(function(path) {\n                    return AudioSound.load(path, _onprogress);\n                })\n            ).then(function() {\n                progress.loaded = progress.total;\n                progress.progress = 1;\n                onprogress(progress);\n                deferred.resolve();\n            }, function(error) {\n                console.log('AudioSound.preload.error', error);\n                deferred.reject(error);\n            });\n            return deferred.promise;\n        }\n\n        $rootScope.$on('onStepChanged', function($scope) {\n            setStep();\n        });\n\n        $rootScope.$on('onOptionsChanged', function($scope) {\n            sound.setVolume(options.audio.volume);\n        });\n\n        this.active = true;\n        this.getData = getData;\n        this.setVolume = setVolume;\n        this.update = update;\n        this.play = play;\n        this.pause = pause;\n        this.toggle = toggle;\n        this.isPlaying = isPlaying;\n        this.isActive = isActive;\n        this.preload = preload;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    var getNow = Date.now || function() {\n        return new Date().getTime();\n    };\n\n    function throttle(callback, wait, options) {\n        // Returns a function, that, when invoked, will only be triggered at most once\n        // during a given window of time. Normally, the throttled function will run\n        // as much as it can, without ever going more than once per `wait` duration;\n        // but if you'd like to disable the execution on the leading edge, pass\n        // `{leading: false}`. To disable execution on the trailing edge, ditto.\n        var context, args, result;\n        var timeout = null;\n        var previous = 0;\n        if (!options) options = {};\n        var later = function() {\n            previous = options.leading === false ? 0 : getNow();\n            timeout = null;\n            result = callback.apply(context, args);\n            if (!timeout) context = args = null;\n        };\n        return function() {\n            var now = getNow();\n            if (!previous && options.leading === false) previous = now;\n            var remaining = wait - (now - previous);\n            context = this;\n            args = arguments;\n            if (remaining <= 0 || remaining > wait) {\n                if (timeout) {\n                    clearTimeout(timeout);\n                    timeout = null;\n                }\n                previous = now;\n                result = callback.apply(context, args);\n                if (!timeout) context = args = null;\n            } else if (!timeout && options.trailing !== false) {\n                timeout = setTimeout(later, remaining);\n            }\n            return result;\n        };\n    }\n\n    app.service('MotionService', ['$rootScope', function($rootScope) {\n\n        var service = this;\n\n        service.x = 0;\n        service.y = 0;\n        service.z = 0;\n        service.init = init;\n\n        function set(x, y, z) {\n            service.x = x;\n            service.y = y;\n            service.z = z;\n            $rootScope.$broadcast('onDeviceMotion', service);\n        }\n\n        function addListeners() {\n            if (window.DeviceOrientationEvent) {\n                window.addEventListener(\"deviceorientation\", onDeviceOrientation, true);\n            }\n            /*\n            if (window.DeviceMotionEvent) {\n                window.addEventListener('devicemotion', onDeviceMotion, true);\n            }    \n            */\n        }\n\n        function onDeviceOrientation(e) {\n            var y = e.beta;\n            var x = e.gamma;\n            var z = 0;\n\n            y = Math.min(y, 30) - 10;\n\n            x /= 30;\n            y /= 30;\n            z /= 30;\n\n            set(x, y, z);\n        }\n\n        function onDeviceMotion(e) {\n            var x = (e.acceleration.x) / 1;\n            var y = (e.acceleration.y) / 1;\n            var z = (e.acceleration.z) / 1;\n            // console.log('onDeviceMotion', x, y, z);\n            set(x, y, z);\n        }\n\n        function init() {\n            addListeners();\n            // console.log('MotionService.init');\n        }\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.service('StepperService', ['$rootScope', '$timeout', '$q', '$http', '$sce', 'SceneOptions', function($rootScope, $timeout, $q, $http, $sce, SceneOptions) {\n\n        var stepper = this;\n        var options = SceneOptions;\n\n        var current = 0;\n        var duration = 2.500; // sec\n        var steps = [];\n        var tweens = [];\n\n        var values = {\n            pow: 0,\n            background: new THREE.Color(options.colors.background),\n            lines: new THREE.Color(options.colors.lines),\n            overLines: new THREE.Color(options.colors.overLines),\n            cameraHeight: options.camera.cameraHeight,\n            targetHeight: options.camera.targetHeight,\n        };\n\n        function init(yearsKey) {\n            var deferred = $q.defer();\n            var index = 0;\n            if (steps.length) {\n                angular.forEach(steps, function(item, i) {\n                    if (item.years.key === yearsKey) {\n                        index = i;\n                    }\n                });\n                values.pow = index / steps.length;\n                stepper.current = current = index;\n                navStep(index);\n                deferred.resolve(steps);\n            } else {\n                $http.get('json/rossini.js').then(function(response) {\n                    var items = response.data;\n                    // var items = getItems();\n                    angular.forEach(items, function(item, i) {\n                        // console.log(item);\n                        item.years.key = String(item.years.to ? item.years.from + '-' + item.years.to : item.years.from); // da riattivare !!!\n                        item.url = '/years/' + item.years.key;\n                        item.detailUrl = item.url + '/detail';\n                        // console.log('stepper.init', item.years.key, yearsKey);\n                        if (item.years.key === yearsKey) {\n                            index = i;\n                        }\n                        item.titleTrusted = $sce.trustAsHtml(item.title);\n                        item.contrast = getContrast(item.colors.background);\n                        item.circle.position = new THREE.Vector3().copy(item.circle.position);\n                        steps.push(item);\n                    });\n                    values.pow = index / steps.length;\n                    stepper.current = current = index;\n                    navStep(index);\n                    // console.log('StepperService.load', steps);\n                    deferred.resolve(steps);\n\n                }, function(error) {\n                    deferred.reject(error);\n\n                });\n            }\n            return deferred.promise;\n        }\n\n        function clearTweens() {\n            while (tweens.length) {\n                var tween = tweens.pop();\n                tween.kill();\n            }\n        }\n\n        function tweenTo(pow, step, duration, callback) {\n            clearTweens();\n            var background = new THREE.Color(step.colors.background);\n            var lines = new THREE.Color(step.colors.lines);\n            var overLines = new THREE.Color(step.colors.overLines);\n            tweens.push(TweenLite.to(stepper.values, duration, {\n                pow: pow,\n                cameraHeight: step.camera.cameraHeight,\n                targetHeight: step.camera.targetHeight,\n                delay: 0,\n                ease: Power2.easeInOut,\n                onComplete: function() {\n                    if (callback) {\n                        callback();\n                    }\n                },\n            }));\n            tweens.push(TweenLite.to(stepper.values.lines, duration, {\n                r: lines.r,\n                g: lines.g,\n                b: lines.b,\n                delay: 0,\n                ease: Power2.easeInOut,\n            }));\n            tweens.push(TweenLite.to(stepper.values.overLines, duration, {\n                r: overLines.r,\n                g: overLines.g,\n                b: overLines.b,\n                delay: 0,\n                ease: Power2.easeInOut,\n            }));\n        }\n\n        function setTweens(duration) {\n            var index = stepper.current;\n            var step = steps[index];\n            tweenTo(index / steps.length, step, duration, function() {\n                clearTweens();\n                // console.log(step, stepper.values);\n            });\n        }\n\n        $rootScope.$on('onOptionsChanged', function() {\n            var index = stepper.current;\n            var step = steps[index];\n            stepper.values.cameraHeight = step.camera.cameraHeight;\n            stepper.values.targetHeight = step.camera.targetHeight;\n            stepper.values.background.copy(new THREE.Color(step.colors.background));\n            stepper.values.lines.copy(new THREE.Color(step.colors.lines));\n            stepper.values.overLines.copy(new THREE.Color(step.colors.overLines));\n            // setTweens(0.250);\n            // console.log('StepperService.onOptionsChanged', index);\n            setBackground(index);\n        });\n\n        $rootScope.$on('onSlickBeforeChange', function($scope, slick) {\n            navStep(slick.current);\n        });\n\n        function setStep(index) {\n            // console.log('StepperService.setStep', index);\n            $timeout(function() {\n                var previous = stepper.current || 0;\n                stepper.current = current = index;\n                var step = steps[index];\n                stepper.step = step;\n                options.colors.background = step.colors.background;\n                options.colors.lines = step.colors.lines;\n                options.colors.overLines = step.colors.overLines;\n                options.camera.cameraHeight = step.camera.cameraHeight;\n                options.camera.targetHeight = step.camera.targetHeight;\n                options.circle.position.copy(step.circle.position);\n                setBackground(index);\n                $rootScope.$broadcast('onStepChanged', { current: index, previous: previous });\n                // console.log('onStepChanged', index, step);\n                setTweens(stepper.duration);\n            });\n        }\n\n        function getCurrentStep() {\n            return steps[current];\n        }\n\n        function getStepAtIndex(index) {\n            return steps[index];\n        }\n\n        function previous() {\n            if (stepper.slicking) {\n                return;\n            }\n            current--;\n            current = Math.max(0, current);\n            navStep(current);\n            $rootScope.$broadcast('onGoStep', current);\n        }\n\n        function next() {\n            if (stepper.slicking) {\n                return;\n            }\n            current++;\n            current = Math.min(steps.length - 1, current);\n            navStep(current);\n            $rootScope.$broadcast('onGoStep', current);\n        }\n\n        function navStep(index) {\n            setStep(index);\n            $rootScope.$broadcast('onGoStep', index);\n            $timeout(function() {\n                var element = $('.tunnel-nav__step.active');\n                if (element.length) {\n                    var position = element.position().top;\n                    var width = element.width() + 16;\n                    $('.tunnel-nav__follower').css({ width: width + 'px', '-webkit-transform': 'translateY(' + position + 'px)', '-moz-transform': 'translateY(' + position + 'px)', '-ms-transform': 'translateY(' + position + 'px)', 'transform': 'translateY(' + position + 'px)' });\n                }\n            });\n        }\n\n        function getItems() {\n            var titles = [\n                'Il periodo francese:<br> la nascita della <em>Grand Opéra</em>',\n                'Il Barbiere di Siviglia<br> al teatro Argentina<br> di Roma',\n                'Il Silenzio',\n            ];\n            var paragraphs = [\n                'Il giovane Gioacchino',\n                'Il folgorante debutto',\n                'La frenesia della produzione',\n                'Sulle strade di Parigi',\n            ];\n            var audioTitles = [\n                'Il Barbiere di Siviglia',\n                'L\\'italiana in Algeri',\n            ];\n            var audios = [\n                'audio/07-rossini-192.mp3',\n                'audio/08-rossini-192.mp3',\n            ];\n            var backgrounds = [\n                'img/tunnel-1.jpg',\n                'img/tunnel-2.jpg',\n                'img/tunnel-3.jpg',\n            ];\n            var items = new Array(options.ribbon.steps).fill().map(function(v, i) {\n                var item = {\n                    id: i + 1,\n                    title: titles[i % titles.length],\n                    url: 'view.html',\n                    chapter: 'Passione, Genio e Silenzio',\n                    paragraph: paragraphs[Math.floor(i / 3) % paragraphs.length],\n                    years: i % 4 === 0 ? {\n                        from: 1812 + Math.round(Math.random() * 50),\n                    } : {\n                        from: 1812 + Math.round(Math.random() * 50),\n                        to: 1812 + Math.round(Math.random() * 50),\n                    },\n                    background: backgrounds[i % backgrounds.length],\n                    colors: angular.copy(SceneOptions.colors),\n                    camera: {\n                        cameraHeight: -10,\n                        targetHeight: 30,\n                    },\n                    circle: {\n                        position: new THREE.Vector3(0, 0, 0),\n                        texture: 'img/rossini-01.png',\n                    },\n                    audio: i > 0 ? {\n                        url: audios[i % audios.length],\n                        title: audioTitles[i % audioTitles.length],\n                        orchestra: 'Academy of St Martin in the Fields Orchestra',\n                    } : null,\n                };\n                if (i > 0 && i % 3 === 0) {\n                    item.colors.background = 0x111111;\n                }\n                return item;\n            });\n            return items;\n        }\n\n        function setBackground(index) {\n            if (!options.useBackground) {\n                var step = stepper.getStepAtIndex(index);\n                var color = new THREE.Color(step.colors.background).getHexString();\n                $('.tunnel-gradient').css('background-color', '#' + color);\n                // console.log('StepperService.setBackground', index, color, step.contrast);\n            }\n        }\n\n        function getContrast(value) {\n            var color = new THREE.Color(value);\n            var r = parseInt(color.r * 255);\n            var g = parseInt(color.g * 255);\n            var b = parseInt(color.b * 255);\n            var pow = r * 0.299 + g * 0.587 + b * 0.114;\n            var contrast = (pow > 125) ? 'light-bg' : 'dark-bg';\n            // console.log('StepperService.getContrast', color.getHexString(), pow, contrast);\n            return contrast;\n        }\n\n        this.init = init;\n        this.values = values;\n        this.duration = duration;\n        this.steps = steps;\n        this.navStep = navStep;\n        this.getCurrentStep = getCurrentStep;\n        this.getStepAtIndex = getStepAtIndex;\n        this.current = current;\n        this.previous = previous;\n        this.next = next;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('scene', ['SceneOptions', 'StepperService', 'AudioService', 'AssetService', 'MotionService', function(SceneOptions, StepperService, AudioService, AssetService, MotionService) {\n        return {\n            restrict: 'A',\n            scope: {\n                data: '=scene',\n            },\n            link: function(scope, element, attributes) {\n                var data = scope.data;\n                if (!data) {\n                    return;\n                }\n\n                var objects = data.objects;\n                var options = SceneOptions;\n                var stepper = StepperService;\n                var audio = AudioService;\n                var assets = AssetService;\n\n                var stats, scene, camera, shadow, back, light, renderer, width, height, w2, h2;\n                var controls = null;\n\n                console.log('scene.options', options);\n\n                scope.$on('onStepChanged', function($scope, step) {\n                    // console.log('onStepChanged', step.current);\n                    var circle = null;\n                    var current = step.current,\n                        previous = step.previous;\n                    if (current > 0) {\n                        circle = objects.circles[current] || getObjectCircles(current);\n                        circle.add();\n                    }\n                    objects.circles[current] = circle;\n                    setTimeout(function() {\n                        if (stepper.current !== previous && previous > 0) {\n                            var circle = objects.circles[previous];\n                            if (circle) {\n                                circle.remove();\n                            }\n                        }\n                    }, stepper.duration * 1000);\n                    // console.log('objects', objects);                    \n                });\n\n                scope.$on('onOptionsChanged', function($scope) {\n                    // optionsChanged\n                    // audio.setVolume(options.audio.volume);\n                });\n\n                var mouse = { x: 0, y: 0 };\n                // var mouseDown = { x: 0, y: 0 };\n                var parallax = { x: 0, y: 0, i: 0 };\n                var translate = { x: 0, y: 0 };\n                var friction = 1 / 12;\n                var motion = MotionService;\n                if (options.device.mobile) {\n                    motion.init();\n                }\n\n                var shadowMaterial = getShadowMaterial();\n\n                function updateParallax() {\n                    if (options.device.mobile) {\n                        // motion.update();\n                        parallax.x = (motion.x * 20);\n                        parallax.y = (motion.y * 20);\n                    } else {\n                        parallax.x = (mouse.x * 20);\n                        parallax.y = (mouse.y * 20);\n                    }\n\n                    var x = parallax.x / 4;\n                    var y = parallax.y / 4;\n\n                    translate.x += (x - translate.x) * friction;\n                    translate.y += (y - translate.y) * friction;\n\n                    if ($('.detail-active').length === 0) {\n                        var translateYear = 'translate(' + (translate.x * -4) + 'px, ' + (translate.y * -2) + 'px)';\n                        $('.tunnel-year__wrap').css({\n                            '-webit-transform': translateYear,\n                            '-moz-transform': translateYear,\n                            'transform': translateYear\n                        });\n                    }\n\n                    var translateSlick = 'translate(' + translate.x + 'px, ' + translate.y + 'px)';\n                    $('.tunnel-slick .slick-active .tunnel-slick__item').css({\n                        '-webit-transform': translateSlick,\n                        '-moz-transform': translateSlick,\n                        'transform': translateSlick\n                    });\n\n                    parallax.x += Math.cos(parallax.i / 100) * 10;\n                    parallax.y += Math.sin(parallax.i / 100) * 10;\n                    parallax.i++;\n                }\n\n                createScene();\n                // createLights();\n                createObjects();\n                addListeners();\n                loop();\n\n                function createScene() {\n                    width = window.innerWidth;\n                    height = window.innerHeight;\n                    w2 = width / 2;\n                    h2 = height / 2;\n\n                    var ratio = width / height;\n                    var fov = 30;\n                    var near = 1;\n                    var far = 20000;\n\n                    scene = new THREE.Scene();\n                    // scene.fog = new THREE.Fog(0x000000, 250, 800);\n\n                    camera = new THREE.PerspectiveCamera(fov, ratio, near, far);\n                    /*\n                    camera.position.z = 100;\n                    camera.position.y = -500;\n                    camera.lookAt(new THREE.Vector3(0, 0, 0));\n                    */\n\n                    renderer = new THREE.WebGLRenderer({\n                        alpha: true,\n                        antialias: true,\n                        logarithmicDepthBuffer: true\n                    });\n\n                    renderer.setClearColor(0x000000, 0); // the default\n                    renderer.setSize(width, height);\n                    renderer.sortObjects = false; // avoid flickering effect\n                    // renderer.shadowMap.enabled = true;\n\n                    stats = new Stats();\n                    element[0].appendChild(renderer.domElement);\n                    element[0].appendChild(stats.dom);\n                }\n\n                function createLights() {\n                    light = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.5);\n                    shadow = new THREE.DirectionalLight(0xffffff, 0.8);\n                    shadow.position.set(200, 200, 200);\n                    shadow.castShadow = true;\n                    // shadow.shadowDarkness = .2;\n                    back = new THREE.DirectionalLight(0xffffff, 0.4);\n                    back.position.set(-100, 200, 50);\n                    // back.shadowDarkness = .2;\n                    back.castShadow = true;\n                    scene.add(light);\n                    scene.add(shadow);\n                    scene.add(back);\n                }\n\n                function createObjects() {\n                    objects.ribbon = getObjectRibbon();\n                    objects.circles = new Array(stepper.steps).fill(null);\n                }\n\n                function getObjectRibbon() {\n\n                    var resolution = new THREE.Vector2(window.innerWidth, window.innerHeight);\n\n                    var material = new MeshLineMaterial({\n                        color: stepper.values.lines,\n                        lineWidth: 5,\n                        opacity: 0.8,\n                        transparent: true,\n                        depthTest: false,\n                        sizeAttenuation: true,\n                        resolution: resolution,\n                        near: camera.near,\n                        far: camera.far,\n                        // blending: THREE.AdditiveBlending,\n                        // side: THREE.DoubleSide,\n                    });\n\n                    var prev = new THREE.Vector3();\n                    var points = new Array(options.ribbon.points).fill(null).map(function() {\n                        var p = new THREE.Vector3().copy(prev);\n                        prev.x += getRandomRange(500, 1000, true);\n                        prev.y += getRandomRange(10, 40, true);\n                        prev.z += getRandomRange(1000, 2000, false);\n                        return p;\n                    });\n\n                    var spline = new THREE.CatmullRomCurve3(points);\n                    spline.type = 'catmullrom';\n                    spline.closed = false;\n\n                    var cameraSpline = new THREE.CatmullRomCurve3(spline.points.map(function(p) {\n                        return new THREE.Vector3(p.x, p.y + 20, p.z);\n                    }));\n                    cameraSpline.type = 'catmullrom';\n                    cameraSpline.closed = false;\n\n                    var geometry = new THREE.Geometry();\n                    geometry.vertices = spline.getPoints(options.ribbon.vertices);\n\n                    var line = new MeshLine();\n                    line.setGeometry(geometry);\n                    // line.setGeometry( geometry, function( p ) { return 2; } ); // makes width 2 * lineWidth\n                    // line.setGeometry( geometry, function( p ) { return 1 - p; } ); // makes width taper\n                    // line.setGeometry(geometry, function(p) { return 2 + Math.sin(50 * p); }); // makes width sinusoidal\n\n                    var object = new THREE.Mesh(line.geometry, material);\n                    add();\n\n                    function add() {\n                        // console.log('objects.ribbon.add');\n                        scene.add(object);\n                    }\n\n                    function remove() {\n                        // console.log('objects.ribbon.remove');\n                        scene.remove(object);\n                    }\n\n                    camera.target = camera.target || new THREE.Vector3(0, 0, 0);\n\n                    function updateRibbon() {\n                        var s = (1 / stepper.steps.length);\n                        var c = s * 0.1;\n                        var cpow = stepper.values.pow;\n                        var tpow = (cpow + c).mod(1);\n                        var step = stepper.getCurrentStep();\n                        var position = cameraSpline.getPointAt(cpow);\n                        position.y += stepper.values.cameraHeight;\n\n                        // object.material.uniforms.visibility.value = Math.min(1.0, stepper.values.pow + s); // riattivare?\n                        // object.material.uniforms.lineWidth.value = 5;\n\n                        var target = cameraSpline.getPointAt(tpow);\n                        target.y += stepper.values.targetHeight;\n                        // var tangent = cameraSpline.getTangent(tpow).normalize().multiplyScalar(100);\n                        // target.add(tangent);\n                        camera.position.copy(position);\n                        camera.target.copy(target);\n                        camera.position.x += (position.x + parallax.x - camera.position.x) * friction;\n                        camera.position.y += (position.y + parallax.y - camera.position.y) * friction;\n                        camera.lookAt(camera.target);\n                    }\n\n                    return {\n                        object: object,\n                        spline: spline,\n                        cameraSpline: cameraSpline,\n                        geometry: geometry,\n                        material: material,\n                        add: add,\n                        remove: remove,\n                        update: updateRibbon,\n                    };\n                }\n\n                function getCanvasMaterial(index, size) {\n                    size = size || 512;\n                    var half = size / 2;\n                    var canvas = document.createElement('canvas');\n                    canvas.width = size;\n                    canvas.height = size;\n                    var context = canvas.getContext('2d');\n                    context.beginPath();\n                    context.arc(half, half, half - 1, 0, Math.PI * 2);\n                    context.clip();\n                    var material = new THREE.MeshBasicMaterial({\n                        color: 0xffffff,\n                        map: new THREE.Texture(canvas),\n                        transparent: true,\n                    });\n                    var step = stepper.getStepAtIndex(index);\n                    var path = step.circle.texture,\n                        img = null;\n                    if (options.preload) {\n                        img = assets.images[path];\n                        context.drawImage(img, 0, 0, size, size);\n                        material.map.needsUpdate = true;\n                    } else {\n                        img = new Image();\n                        img.onload = function() {\n                            context.drawImage(img, 0, 0, size, size);\n                            material.map.needsUpdate = true;\n                        };\n                        img.src = path;\n                    }\n                    return material;\n                }\n\n                function getShadowMaterial(size) {\n                    size = size || 512;\n                    var half = size / 2;\n                    var canvas = document.createElement('canvas');\n                    canvas.width = size;\n                    canvas.height = size;\n                    var context = canvas.getContext('2d');\n                    var gradient = context.createRadialGradient(half, half, 30, half, half, half);\n                    gradient.addColorStop(0, 'rgba(0,0,0,0.35)');\n                    gradient.addColorStop(0.1, 'rgba(0,0,0,0.33)');\n                    gradient.addColorStop(1, 'rgba(0,0,0,0.0)');\n                    context.fillStyle = gradient;\n                    context.fillRect(0, 0, size, size);\n                    var material = new THREE.MeshBasicMaterial({\n                        color: 0xffffff,\n                        map: new THREE.Texture(canvas),\n                        transparent: true,\n                    });\n                    material.map.needsUpdate = true;\n                    /*\n                    var texture = new THREE.TextureLoader().load('img/shadow.png');\n                    texture.wrapS = THREE.RepeatWrapping;\n                    texture.wrapT = THREE.RepeatWrapping;\n                    texture.repeat.set(1, 1);\n                    var material = new THREE.MeshBasicMaterial({\n                        color: 0xffffff,\n                        map: texture,\n                        transparent: true,\n                    });\n                    */\n                    return material;\n                }\n\n                function getObjectCircles(index) {\n                    var noiseMap1 = getPerlinNoise(options.circle.points, options.circle.lines);\n                    var noiseMap2 = getPerlinNoise(options.circle.points, options.circle.lines);\n                    var geometry, object, circles = [];\n                    var ln = options.circle.lines;\n                    var pn = options.circle.points;\n                    var step = stepper.getStepAtIndex(index);\n                    var resolution = new THREE.Vector2(window.innerWidth, window.innerHeight);\n\n                    var material = getCanvasMaterial(index);\n                    var material1 = new THREE.LineBasicMaterial({\n                        color: stepper.values.lines,\n                        transparent: true,\n                    });\n                    var material2 = new THREE.LineBasicMaterial({\n                        color: stepper.values.overLines,\n                        transparent: true,\n                    });\n\n                    var materialLine1 = new MeshLineMaterial({\n                        color: stepper.values.lines,\n                        lineWidth: 1.0,\n                        depthTest: false,\n                        opacity: 1,\n                        transparent: true,\n                        resolution: resolution,\n                        near: camera.near,\n                        far: camera.far,\n                    });\n\n                    var materialLine2 = new MeshLineMaterial({\n                        color: stepper.values.overLines,\n                        lineWidth: 1.0,\n                        depthTest: false,\n                        opacity: 1,\n                        transparent: true,\n                        resolution: resolution,\n                        near: camera.near,\n                        far: camera.far,\n                    });\n\n                    object = new THREE.Object3D();\n\n                    var points1 = [],\n                        points2 = [],\n                        meshLines1 = [],\n                        meshLines2 = [],\n                        meshLineGeometries1 = [],\n                        meshLineGeometries2 = [],\n                        useMeshLines = false;\n\n                    var dummy = new THREE.Object3D();\n                    object.add(dummy);\n\n                    // shadow\n                    geometry = new THREE.PlaneGeometry(options.circle.radius * 2 - 20, options.circle.radius * 2 - 20, 8, 8);\n                    var shadowPlane = new THREE.Mesh(geometry, shadowMaterial);\n                    shadowPlane.position.y = -400;\n                    shadowPlane.rotation.x = -Math.PI / 2;\n                    shadowPlane.scale.z = 0.5;\n                    dummy.add(shadowPlane);\n                    // shadow\n\n                    // circle\n                    geometry = new THREE.PlaneGeometry(options.circle.radius * 2 - 20, options.circle.radius * 2 - 20, 8, 8);\n                    var plane = new THREE.Mesh(geometry, material);\n                    plane.position.z = -30;\n                    dummy.add(plane);\n                    // circle\n\n                    var group1 = new THREE.Object3D();\n                    dummy.add(group1);\n\n                    var group2 = new THREE.Object3D();\n                    dummy.add(group2);\n\n                    var lines1 = new Array(ln).fill(null).map(getLine1);\n                    var lines2 = new Array(ln).fill(null).map(getLine2);\n\n                    var state = {\n                        pow: 0,\n                        enabled: false,\n                        adding: false,\n                        removing: false,\n                    };\n\n                    var to = null;\n\n                    function add() {\n                        // console.log('objects.circles.add');\n                        scene.add(object);\n                        state.adding = Date.now();\n                        state.removing = false;\n                        state.enabled = true;\n                        if (state.tween) {\n                            state.tween.kill();\n                        }\n                        // 2.000\n                        state.tween = TweenLite.to(state, 0.350, {\n                            pow: 1,\n                            delay: 0,\n                            ease: Power2.easeOut, // Elastic.easeOut.config(1, 0.3),\n                            onComplete: function() {\n                                state.adding = false;\n                            },\n                        });\n                    }\n\n                    function remove() {\n                        // console.log('objects.circles.remove');\n                        state.adding = false;\n                        state.removing = Date.now();\n                        if (state.tween) {\n                            state.tween.kill();\n                        }\n                        state.tween = TweenLite.to(state, 0.350, {\n                            pow: 0,\n                            delay: 0,\n                            ease: Power2.easeOut,\n                            onComplete: function() {\n                                state.removing = false;\n                                state.enabled = false;\n                                scene.remove(object);\n                            },\n                        });\n                    }\n\n                    var iterator = 0;\n\n                    function getLine1(v, i) {\n                        var geometry = new THREE.Geometry();\n                        var points = addPoints(geometry, i, 1);\n                        points1.push(points);\n                        var line = null;\n                        if (useMeshLines) {\n                            var meshLine = new MeshLine();\n                            meshLine.setGeometry(geometry);\n                            meshLineGeometries1.push(geometry);\n                            meshLines1.push(meshLine);\n                            // meshLine.setGeometry( geometry, function( p ) { return 2; } ); // makes width 2 * lineWidth\n                            // meshLine.setGeometry( geometry, function( p ) { return 1 - p; } ); // makes width taper\n                            // meshLine.setGeometry( geometry, function( p ) { return 2 + Math.sin( 50 * p ); } ); // makes width sinusoidal\n                            line = new THREE.Mesh(meshLine.geometry, materialLine1);\n                        } else {\n                            line = new THREE.LineLoop(geometry, material1.clone());\n                            // var spline = new THREE.CatmullRomCurve3(points);\n                            // circle.spline = spline;\n                        }\n                        group1.add(line);\n                        return line;\n                    }\n\n                    function getLine2(v, i) {\n                        var geometry = new THREE.Geometry();\n                        var points = addPoints(geometry, i, 2);\n                        points2.push(points);\n                        var line = null;\n                        if (useMeshLines) {\n                            var meshLine = new MeshLine();\n                            meshLine.setGeometry(geometry);\n                            meshLineGeometries2.push(geometry);\n                            meshLines2.push(meshLine);\n                            // meshLine.setGeometry( geometry, function( p ) { return 2; } ); // makes width 2 * lineWidth\n                            // meshLine.setGeometry( geometry, function( p ) { return 1 - p; } ); // makes width taper\n                            // meshLine.setGeometry( geometry, function( p ) { return 2 + Math.sin( 50 * p ); } ); // makes width sinusoidal\n                            line = new THREE.Mesh(meshLine.geometry, materialLine2);\n                        } else {\n                            line = new THREE.LineLoop(geometry, material2.clone());\n                            // var spline = new THREE.CatmullRomCurve3(points);\n                            // circle.spline = spline;\n                        }\n                        group2.add(line);\n                        return line;\n                    }\n\n                    function addPoints(geometry, l, g) {\n                        var points = new Array(pn).fill(null).map(function(v, i) {\n                            var ratio = i / pn;\n                            var degrees = 360 * ratio; // point degrees;\n                            degrees += 60 * index; // circle offset;\n                            degrees += 30 * g; // group offset;\n                            degrees += (360 / pn * 0.1) * l; // line offset;\n                            var radians = degrees * Math.PI / 180;\n                            var radius = options.circle.radius;\n                            var increment = 0;\n                            if (g === 1) {\n                                increment += (l * l * l * 0.005);\n                            } else {\n                                increment += (l * l * l * 0.005);\n                            }\n                            v = new THREE.Vector3();\n                            v.sincos = {\n                                base: radius,\n                                increment: increment,\n                                radius: radius,\n                                x: Math.cos(radians),\n                                y: Math.sin(radians),\n                            };\n                            geometry.vertices.push(v);\n                            return v;\n                        });\n                        geometry.vertices.push(points[0]);\n                        return points;\n                    }\n\n                    function updateLine(geometry, vertices, l, g) {\n                        var audioStrength = options.audioStrength,\n                            noiseStrength = options.noiseStrength,\n                            circularStrength = options.circularStrength,\n                            noiseMap = g === 1 ? noiseMap1 : noiseMap2,\n                            data = audio.getData(),\n                            totalPow = 0;\n\n                        angular.forEach(vertices, function(v, i) {\n                            var bands = options.audio.bands;\n                            var aia = i % bands;\n                            var aib = (pn - 1 - i) % bands;\n                            var audioPow = data ? ((data[aia] + data[aib]) / 2) / bands : 0;\n                            totalPow += audioPow;\n                            // var audioPow = data[aia] / bands;\n\n                            var ni = 0; // iterator;\n\n                            var nd = g === 1 ? 0 : 64;\n                            var nia = l * pn + ((i + nd + ni) % pn);\n                            var nib = l * pn + (((pn - 1 - i - nd) + ni) % pn);\n                            var noisePow = (noiseMap[nia] + noiseMap[nib]) / 2 / 64;\n\n                            var linePow = 1 - ((ln - l) / ln * circularStrength);\n\n                            var radius = v.sincos.base +\n                                (v.sincos.increment * noisePow) +\n                                (v.sincos.increment * audioPow) +\n                                (noiseStrength * noisePow) * linePow +\n                                (audioStrength * audioPow) * linePow +\n                                // (audioStrength * (3 - g) * audioPow * (l * 0.1)) * linePow +\n                                0;\n\n                            v.sincos.radius = radius;\n                            // v.sincos.radius += (radius - v.sincos.radius) / 2;\n\n                            v.x = v.sincos.x * v.sincos.radius;\n                            v.y = v.sincos.y * v.sincos.radius;\n                            v.z = 10 * g + l * 0.01; // -l;\n                            // console.log(v.sincos.radius);\n                        });\n\n                        if (g === 1) {\n                            shadowPlane.scale.x = 1.0 + (totalPow / vertices.length);\n                        }\n\n                        geometry.verticesNeedUpdate = true;\n\n                        /*\n                        var f = 0;\n                        var l = pn - 1;\n                        var first = new THREE.Vector3().copy(vertices[f]);\n                        var last = new THREE.Vector3().copy(vertices[l]);\n                        vertices[f].add(new THREE.Vector3().subVectors(first, last).multiplyScalar(0.5));\n                        vertices[l].add(new THREE.Vector3().subVectors(first, last).multiplyScalar(-0.5));\n                        \n                        lines.forEach( function( l, i ) {\n                        if( params.animateWidth ) l.material.uniforms.lineWidth.value = params.lineWidth * ( 1 + .5 * Math.sin( 5 * t + i ) );\n                        if( params.autoRotate ) l.rotation.y += .125 * delta;\n                        l.material.uniforms.visibility.value= params.animateVisibility ? (time/3000) % 1.0 : 1.0;\n                        \n                        if (iterator === 60 && g === 2 && l === 0) {\n                            // console.log('vertices', geometry.vertices.map(function(v) { return v.x + ',' + v.y; }));\n                        }\n                        */\n                    }\n\n                    var dummyMobilePosition = new THREE.Vector3(0, 100, 0);\n\n                    function updateCircle() {\n\n                        material.opacity = state.pow;\n                        // material1.opacity = state.pow;\n                        // material2.opacity = state.pow;\n                        // material1.color = stepper.values.lines;\n                        // material2.color = stepper.values.overLines;\n\n                        // console.log(stepper.values.overLines);\n\n                        // if (useMeshLines) {\n                        //    materialLine1.uniforms.lineWidth.value = state.pow;\n                        //    materialLine2.uniforms.lineWidth.value = state.pow;\n                        // }\n\n                        angular.forEach(lines1, function(line, l) {\n                            updateLine(line.geometry, points1[l], l, 1);\n                            line.material.opacity = (0.0 + (1.0 * l / ln)) * state.pow;\n                            line.material.color = stepper.values.lines;\n                            // line.geometry.colorsNeedUpdate = true;\n                            if (useMeshLines) {\n                                meshLines1[l].setGeometry(meshLineGeometries1[l]);\n                            }\n                        });\n\n                        angular.forEach(lines2, function(line, l) {\n                            updateLine(line.geometry, points2[l], l, 2);\n                            line.material.opacity = (0.0 + (1.0 * l / ln)) * state.pow;\n                            line.material.color = stepper.values.overLines;\n                            // line.geometry.colorsNeedUpdate = true;\n                            if (useMeshLines) {\n                                meshLines2[l].setGeometry(meshLineGeometries2[l]);\n                            }\n                        });\n\n                        group1.rotation.z += 0.001;\n                        group2.rotation.z -= 0.001;\n\n                        if (width > 1023) {\n                            dummy.position.copy(step.circle.position);\n                        } else {\n                            dummy.position.copy(dummyMobilePosition);\n                        }\n\n                        dummy.rotation.x += ((parallax.y * 0.00625) - dummy.rotation.x) * friction;\n                        dummy.rotation.y += ((parallax.x * 0.01250) - dummy.rotation.y) * friction;\n\n                        var position = objects.ribbon.cameraSpline.getPointAt((index + 0.1) / stepper.steps.length);\n                        // var tangent = objects.ribbon.cameraSpline.getTangent(index + 0.1 / stepper.steps.length).normalize().multiplyScalar(300);\n                        // position.add(tangent);\n\n                        position.y += stepper.values.targetHeight;\n                        object.position.copy(position);\n\n                        // object.position.x += (position.x + Math.random() * 20 - object.position.x) / 40;\n                        // object.position.y += (position.y + Math.random() * 20 - object.position.y) / 40;\n                        // object.position.z += (position.z + Math.random() * 20 - object.position.z) / 40;\n\n                        object.scale.x = object.scale.y = object.scale.z = 0.001 + 0.14 * state.pow;\n                        object.lookAt(camera.position);\n\n                        // iterator++;\n                    }\n\n                    return {\n                        add: add,\n                        remove: remove,\n                        object: object,\n                        state: state,\n                        update: updateCircle,\n                    };\n                }\n\n                function update() {\n                    /*\n                    if (controls) {\n                        controls.update();\n                    }\n                    */\n                    updateParallax();\n                    audio.update();\n                    if (objects.ribbon) {\n                        objects.ribbon.update();\n                    }\n                    angular.forEach(objects.circles, function(circle) {\n                        if (circle && circle.state.enabled) {\n                            circle.update();\n                        }\n                    });\n                }\n\n                function render() {\n                    update();\n                    renderer.render(scene, camera);\n                }\n\n                function loop() {\n                    stats.begin();\n                    render();\n                    stats.end();\n                    requestAnimationFrame(loop);\n                }\n\n                function addListeners() {\n\n                    function onWindowResize() {\n                        width = window.innerWidth;\n                        height = window.innerHeight;\n                        w2 = width / 2;\n                        h2 = height / 2;\n                        renderer.setSize(width, height);\n                        camera.aspect = width / height;\n                        camera.updateProjectionMatrix();\n                    }\n\n                    function handleMouseMove(event) {\n                        var halfW = window.innerWidth / 2;\n                        var halfH = window.innerHeight / 2;\n                        mouse.x = (event.clientX - halfW) / halfW;\n                        mouse.y = (event.clientY - halfH) / halfH;\n                    }\n\n                    window.addEventListener('resize', onWindowResize, false);\n                    document.addEventListener('mousemove', handleMouseMove, false);\n\n                    /*\n                    \n\n                    function handleMouseDown(event) {\n                        //\n                    }\n\n                    function handleMouseUp(event) {\n                        //\n                    }\n\n                    function handleTouchStart(event) {\n                        if (event.touches.length > 1) {\n                            event.preventDefault();\n                            mouseDown = { x: event.touches[0].pageX, y: event.touches[0].pageY };\n                        }\n                    }\n\n                    function handleTouchEnd(event) {\n                        mouseDown = { x: windowHalfX, y: windowHalfY };\n                    }\n\n                    function handleTouchMove(event) {\n                        if (event.touches.length == 1) {\n                            event.preventDefault();\n                            mouseDown = { x: event.touches[0].pageX, y: event.touches[0].pageY };\n                        }\n                    }\n                    */\n                    /*\n                    document.addEventListener('mousedown', handleMouseDown, false);\n                    document.addEventListener('mouseup', handleMouseUp, false);\n                    document.addEventListener('touchstart', handleTouchStart, false);\n                    document.addEventListener('touchend', handleTouchEnd, false);\n                    document.addEventListener('touchmove', handleTouchMove, false);\n                    */\n                }\n\n            }\n        };\n    }]);\n\n    Number.prototype.mod = function(n) {\n        return ((this % n) + n) % n;\n    };\n\n    function getPerlinNoise(width, height) {\n        var size = width * height,\n            data = new Uint8Array(size),\n            perlin = new ImprovedNoise(),\n            quality = 1,\n            z = Math.random() * 100;\n        for (var j = 0; j < 4; j++) {\n            for (var i = 0; i < size; i++) {\n                var x = i % width,\n                    y = ~~(i / width);\n                data[i] += Math.abs(perlin.noise(x / quality, y / quality, z) * quality * 1.75);\n            }\n            quality *= 5;\n        }\n        return data;\n    }\n\n    function ImprovedNoise() {\n        var p = [151, 160, 137, 91, 90, 15, 131, 13, 201, 95, 96, 53, 194, 233, 7, 225, 140, 36, 103, 30, 69, 142, 8, 99, 37, 240, 21, 10,\n            23, 190, 6, 148, 247, 120, 234, 75, 0, 26, 197, 62, 94, 252, 219, 203, 117, 35, 11, 32, 57, 177, 33, 88, 237, 149, 56, 87,\n            174, 20, 125, 136, 171, 168, 68, 175, 74, 165, 71, 134, 139, 48, 27, 166, 77, 146, 158, 231, 83, 111, 229, 122, 60, 211,\n            133, 230, 220, 105, 92, 41, 55, 46, 245, 40, 244, 102, 143, 54, 65, 25, 63, 161, 1, 216, 80, 73, 209, 76, 132, 187, 208,\n            89, 18, 169, 200, 196, 135, 130, 116, 188, 159, 86, 164, 100, 109, 198, 173, 186, 3, 64, 52, 217, 226, 250, 124, 123, 5,\n            202, 38, 147, 118, 126, 255, 82, 85, 212, 207, 206, 59, 227, 47, 16, 58, 17, 182, 189, 28, 42, 223, 183, 170, 213, 119,\n            248, 152, 2, 44, 154, 163, 70, 221, 153, 101, 155, 167, 43, 172, 9, 129, 22, 39, 253, 19, 98, 108, 110, 79, 113, 224, 232,\n            178, 185, 112, 104, 218, 246, 97, 228, 251, 34, 242, 193, 238, 210, 144, 12, 191, 179, 162, 241, 81, 51, 145, 235, 249,\n            14, 239, 107, 49, 192, 214, 31, 181, 199, 106, 157, 184, 84, 204, 176, 115, 121, 50, 45, 127, 4, 150, 254, 138, 236, 205,\n            93, 222, 114, 67, 29, 24, 72, 243, 141, 128, 195, 78, 66, 215, 61, 156, 180\n        ];\n        for (var i = 0; i < 256; i++) {\n            p[256 + i] = p[i];\n        }\n\n        function fade(t) {\n            return t * t * t * (t * (t * 6 - 15) + 10);\n        }\n\n        function lerp(t, a, b) {\n            return a + t * (b - a);\n        }\n\n        function grad(hash, x, y, z) {\n            var h = hash & 15;\n            var u = h < 8 ? x : y,\n                v = h < 4 ? y : h == 12 || h == 14 ? x : z;\n            return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);\n        }\n\n        return {\n            noise: function(x, y, z) {\n                var floorX = Math.floor(x),\n                    floorY = Math.floor(y),\n                    floorZ = Math.floor(z);\n                var X = floorX & 255,\n                    Y = floorY & 255,\n                    Z = floorZ & 255;\n                x -= floorX;\n                y -= floorY;\n                z -= floorZ;\n                var xMinus1 = x - 1,\n                    yMinus1 = y - 1,\n                    zMinus1 = z - 1;\n                var u = fade(x),\n                    v = fade(y),\n                    w = fade(z);\n                var A = p[X] + Y,\n                    AA = p[A] + Z,\n                    AB = p[A + 1] + Z,\n                    B = p[X + 1] + Y,\n                    BA = p[B] + Z,\n                    BB = p[B + 1] + Z;\n                return lerp(w, lerp(v, lerp(u, grad(p[AA], x, y, z),\n                            grad(p[BA], xMinus1, y, z)),\n                        lerp(u, grad(p[AB], x, yMinus1, z),\n                            grad(p[BB], xMinus1, yMinus1, z))),\n                    lerp(v, lerp(u, grad(p[AA + 1], x, y, zMinus1),\n                            grad(p[BA + 1], xMinus1, y, z - 1)),\n                        lerp(u, grad(p[AB + 1], x, yMinus1, zMinus1),\n                            grad(p[BB + 1], xMinus1, yMinus1, zMinus1))));\n\n            }\n        };\n    }\n\n    function getRandomRange(min, max, allowNegatives) {\n        var n = -1 + Math.random() * 2;\n        var a = Math.abs(n);\n        var s = allowNegatives ? Math.floor(n / a) : 1;\n        return s * (min + (max - min) * a);\n    }\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    function mobilecheck() {\n        var check = false;\n        (function(a) { if (/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);\n        return check;\n    }\n\n    // For those wishing to include tablets in this test (though arguably, you shouldn't), you can use the following function:\n    function mobileAndTabletcheck() {\n        var check = false;\n        (function(a) { if (/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);\n        return check;\n    }\n\n    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n    var isMobile = mobilecheck();\n    var isMobileAndTabled = mobileAndTabletcheck();\n\n    app.constant('SceneOptions', {\n        colors: {\n            background: 0xeae8e8,\n            lines: 0xb4bfdd,\n            overLines: 0x3353a4,\n        },\n        camera: {\n            cameraHeight: -10,\n            targetHeight: 30,\n        },\n        ribbon: {\n            steps: 12,\n            points: 24,\n            vertices: isMobileAndTabled ? 1200 : 2400,\n        },\n        circle: {\n            position: new THREE.Vector3(),\n            radius: 200,\n            lines: isMobileAndTabled ? 12 : 24,\n            points: isMobileAndTabled ? 64 : 128,\n        },\n        audio: {\n            volume: 0.9,\n            bands: isMobileAndTabled ? 64 : 128,\n        },\n        audioStrength: 100,\n        noiseStrength: 25,\n        circularStrength: 0.90,\n        useBackground: false,\n        device: {\n            mobile: isMobileAndTabled,\n            ios: isIOS,\n        },\n        preload: false,\n    });\n\n}());"]}