{"version":3,"sources":["docs/js/app.js"],"names":["angular","module","config","$httpProvider","$locationProvider","html5Mode","hashPrefix","run","$rootScope","factory","SceneOptions","StepperService","DatGui","onOptionsChanged","params","step","stepper","getCurrentStep","colors","background","options","lines","overLines","camera","cameraHeight","targetHeight","circle","position","copy","$broadcast","gui","dat","GUI","randomize","i","__controllers","length","c","__min","value","__max","Math","random","this","property","updateDisplay","__color","r","floor","g","b","setValue","hex","saveJson","console","log","downloadFile","steps","closed","add","listen","onChange","circlePosition","addFolder","addColor","a","document","createElement","body","appendChild","style","data","fileName","json","pretty","JSON","stringify","blob","Blob","type","url","window","URL","createObjectURL","href","download","click","revokeObjectURL","getPerlinNoise","width","height","size","Uint8Array","perlin","ImprovedNoise","quality","z","j","x","y","abs","noise","fade","t","lerp","grad","hash","h","u","v","p","floorX","floorY","floorZ","X","Y","Z","xMinus1","yMinus1","zMinus1","w","A","AA","AB","B","BA","BB","getRandomRange","min","max","allowNegatives","n","app","Number","prototype","mod","service","$q","$http","init","source","ctx","actx","AudioContext","webkitAudioContext","analyser","createAnalyser","audio","Audio","addEventListener","bufferLength","createMediaElementSource","connect","destination","fftSize","bands","frequencyBinCount","setStep","setAudioUrl","$audioUrl","audioUrl","src","volume","audioVolume","play","pause","toggle","active","update","getByteFrequencyData","$on","$scope","directive","AnalyserService","restrict","scope","link","element","attributes","getObjectRibbon","scene","object","remove","updateRibbon","cpow","values","pow","tpow","cameraSpline","getPointAt","target","lookAt","getMaterial","THREE","Vector2","innerWidth","innerHeight","MeshLineMaterial","color","lineWidth","depthTest","updateRibbonMaterial","objects","ribbon","material","prev","Vector3","points","Array","fill","map","spline","CatmullRomCurve3","geometry","Geometry","vertices","getPoints","line","MeshLine","setGeometry","Mesh","updateMaterial","getObjectCircles","index","state","adding","Date","now","removing","enabled","tween","kill","TweenLite","to","duration","delay","ease","Power2","easeInOut","onComplete","getLine1","addPoints","LineLoop","material1","points1","push","group1","getLine2","material2","points2","group2","l","pn","ratio","degrees","radians","PI","radius","increment","sincos","base","cos","sin","updateLine","audioStrength","noiseStrength","circularStrength","forEach","aia","aib","audioPow","nd","nia","iterator","nib","noisePow","noiseMap","linePow","ln","verticesNeedUpdate","updateCircle","lines1","lines2","rotation","getStepAtIndex","dummy","scale","updateCircleMaterial","LineBasicMaterial","Object3D","texture","TextureLoader","load","wrapS","RepeatWrapping","wrapT","repeat","set","MeshBasicMaterial","transparent","PlaneGeometry","plane","render","controls","circles","renderer","loop","stats","begin","end","requestAnimationFrame","w2","h2","current","previous","setTimeout","Scene","PerspectiveCamera","WebGLRenderer","alpha","antialias","logarithmicDepthBuffer","setClearColor","setSize","Stats","domElement","dom","onWindowResize","aspect","updateProjectionMatrix","unSlick","hasClass","slick","onSlick","arrows","dots","speed","infinite","lazyLoad","cssEase","$watchCollection","slickBackgrounds","items","draggable","asNavFor","onInit","letters","$","TweenMax","staggerTo","Power3","className","addClass","onBeforeChange","event","currentSlide","nextSlide","tunnelAnimating","removeClass","$root","previouse","onAfterChange","onWheel","e","deltaX","deltaY","preventDefault","removeListeners","off","slickTunnel","on","splitText","nodes","childNodes","slice","call","html","rows","filter","node","nodeType","text","trim","textContent","nodeName","toLowerCase","innerHTML","row","appendTo","el","words","split","word","letter","from","onChangeYears","updateYear","yearFrom","parseInt","years","yearTo","find","easing","easeOut","roundProps","onUpdate","$watch","newValue","oldValue","constant","controller","then","$timeout","$sce","getItems","titles","audioTitles","audios","backgrounds","contrasts","id","name","title","chapter","paragraph","round","contrast","orchestra","deferred","defer","get","response","item","titleTrusted","trustAsHtml","resolve","error","reject","promise","clearTweens","tweens","pop","tweenTo","callback","Color","getHexString","backgroundColor","setTweens","next","model","Init","scrollbar","Scrollbar","native","contentEl","offsetHeight","damping","overscrollDamping","thumbMinSize","continuousScrolling","alwaysShowTracks"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app', ['ngRoute', 'ngSanitize', 'jsonFormatter']);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.config(['$httpProvider', function($httpProvider) {\n        // $httpProvider.defaults.withCredentials = true;\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.config(['$locationProvider', function($locationProvider) {\n\n        // HTML5 MODE url writing method (false: #/anchor/use, true: /html5/url/use)\n        $locationProvider.html5Mode(true);\n        $locationProvider.hashPrefix('');\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.run(['$rootScope', function($rootScope) {\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.factory('DatGui', ['$rootScope', 'SceneOptions', 'StepperService', function($rootScope, SceneOptions, StepperService) {\n\n        var downloadFile = function downloadFile() {\n            var a = document.createElement(\"a\");\n            document.body.appendChild(a);\n            a.style = \"display: none\";\n            return function(data, fileName, json, pretty) {\n                if (json) {\n                    if (pretty) {\n                        data = JSON.stringify(data, null, 2); // spacing level = 2\n                    } else {\n                        data = JSON.stringify(data);\n                    }\n                }\n                var blob = new Blob([data], { type: \"octet/stream\" }),\n                    url = window.URL.createObjectURL(blob);\n                a.href = url;\n                a.download = fileName;\n                a.click();\n                window.URL.revokeObjectURL(url);\n            };\n        }();\n\n        function DatGui() {\n            var options = SceneOptions;\n            var stepper = StepperService;\n            var gui = new dat.GUI();\n\n            options.randomize = function() {\n                for (var i = 0; i < gui.__controllers.length; i++) {\n                    var c = gui.__controllers[i];\n                    if (c.__min) {\n                        var value = c.__min + (c.__max - c.__min) * Math.random();\n                        this[c.property] = value;\n                        c.updateDisplay();\n                    }\n                    if (c.__color) {\n                        c.__color.r = Math.floor(Math.random() * 255);\n                        c.__color.g = Math.floor(Math.random() * 255);\n                        c.__color.b = Math.floor(Math.random() * 255);\n                        c.updateDisplay();\n                        c.setValue(c.__color.hex);\n                    }\n                }\n            };\n\n            options.saveJson = function() {\n                console.log('saveJson');\n                downloadFile(stepper.steps, 'rossini.js', true, true);\n            };\n\n            function onOptionsChanged(params) {\n                var step = stepper.getCurrentStep();\n                step.colors.background = options.colors.background;\n                step.colors.lines = options.colors.lines;\n                step.colors.overLines = options.colors.overLines;\n                step.camera.cameraHeight = options.camera.cameraHeight;\n                step.camera.targetHeight = options.camera.targetHeight;\n                step.circle.position.copy(options.circle.position);\n                $rootScope.$broadcast('onOptionsChanged');\n            }\n\n            gui.closed = true;\n            gui.add(options.camera, 'cameraHeight', -20.0, 20.0).listen().onChange(onOptionsChanged);\n            gui.add(options.camera, 'targetHeight', -20.0, 20.0).listen().onChange(onOptionsChanged);\n            var circlePosition = gui.addFolder('circlePosition');\n            circlePosition.add(options.circle.position, 'x', -300, 300).listen().onChange(onOptionsChanged);\n            circlePosition.add(options.circle.position, 'y', -300, 300).listen().onChange(onOptionsChanged);\n            circlePosition.add(options.circle.position, 'z', -300, 300).listen().onChange(onOptionsChanged);\n            var colors = gui.addFolder('colors');\n            colors.addColor(options.colors, 'background').listen().onChange(onOptionsChanged);\n            colors.addColor(options.colors, 'lines').listen().onChange(onOptionsChanged);\n            colors.addColor(options.colors, 'overLines').listen().onChange(onOptionsChanged);\n            gui.add(options, 'audioVolume', 0.01, 1.0).onChange(onOptionsChanged);\n            gui.add(options, 'audioStrength', 10, 100).onChange(onOptionsChanged);\n            gui.add(options, 'noiseStrength', 10, 100).onChange(onOptionsChanged);\n            gui.add(options, 'circularStrength', 0.01, 0.90).onChange(onOptionsChanged);\n            gui.add(options, 'randomize');\n            gui.add(options, 'saveJson');\n\n            onOptionsChanged();\n\n            return gui;\n        }\n\n        return DatGui;\n\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    Number.prototype.mod = function(n) {\n        return ((this % n) + n) % n;\n    };\n\n    function getPerlinNoise(width, height) {\n        var size = width * height,\n            data = new Uint8Array(size),\n            perlin = new ImprovedNoise(),\n            quality = 1,\n            z = Math.random() * 100;\n        for (var j = 0; j < 4; j++) {\n            for (var i = 0; i < size; i++) {\n                var x = i % width,\n                    y = ~~(i / width);\n                data[i] += Math.abs(perlin.noise(x / quality, y / quality, z) * quality * 1.75);\n            }\n            quality *= 5;\n        }\n        return data;\n    }\n\n    function ImprovedNoise() {\n        var p = [151, 160, 137, 91, 90, 15, 131, 13, 201, 95, 96, 53, 194, 233, 7, 225, 140, 36, 103, 30, 69, 142, 8, 99, 37, 240, 21, 10,\n            23, 190, 6, 148, 247, 120, 234, 75, 0, 26, 197, 62, 94, 252, 219, 203, 117, 35, 11, 32, 57, 177, 33, 88, 237, 149, 56, 87,\n            174, 20, 125, 136, 171, 168, 68, 175, 74, 165, 71, 134, 139, 48, 27, 166, 77, 146, 158, 231, 83, 111, 229, 122, 60, 211,\n            133, 230, 220, 105, 92, 41, 55, 46, 245, 40, 244, 102, 143, 54, 65, 25, 63, 161, 1, 216, 80, 73, 209, 76, 132, 187, 208,\n            89, 18, 169, 200, 196, 135, 130, 116, 188, 159, 86, 164, 100, 109, 198, 173, 186, 3, 64, 52, 217, 226, 250, 124, 123, 5,\n            202, 38, 147, 118, 126, 255, 82, 85, 212, 207, 206, 59, 227, 47, 16, 58, 17, 182, 189, 28, 42, 223, 183, 170, 213, 119,\n            248, 152, 2, 44, 154, 163, 70, 221, 153, 101, 155, 167, 43, 172, 9, 129, 22, 39, 253, 19, 98, 108, 110, 79, 113, 224, 232,\n            178, 185, 112, 104, 218, 246, 97, 228, 251, 34, 242, 193, 238, 210, 144, 12, 191, 179, 162, 241, 81, 51, 145, 235, 249,\n            14, 239, 107, 49, 192, 214, 31, 181, 199, 106, 157, 184, 84, 204, 176, 115, 121, 50, 45, 127, 4, 150, 254, 138, 236, 205,\n            93, 222, 114, 67, 29, 24, 72, 243, 141, 128, 195, 78, 66, 215, 61, 156, 180\n        ];\n        for (var i = 0; i < 256; i++) {\n            p[256 + i] = p[i];\n        }\n\n        function fade(t) {\n            return t * t * t * (t * (t * 6 - 15) + 10);\n        }\n\n        function lerp(t, a, b) {\n            return a + t * (b - a);\n        }\n\n        function grad(hash, x, y, z) {\n            var h = hash & 15;\n            var u = h < 8 ? x : y,\n                v = h < 4 ? y : h == 12 || h == 14 ? x : z;\n            return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);\n        }\n\n        return {\n            noise: function(x, y, z) {\n                var floorX = Math.floor(x),\n                    floorY = Math.floor(y),\n                    floorZ = Math.floor(z);\n                var X = floorX & 255,\n                    Y = floorY & 255,\n                    Z = floorZ & 255;\n                x -= floorX;\n                y -= floorY;\n                z -= floorZ;\n                var xMinus1 = x - 1,\n                    yMinus1 = y - 1,\n                    zMinus1 = z - 1;\n                var u = fade(x),\n                    v = fade(y),\n                    w = fade(z);\n                var A = p[X] + Y,\n                    AA = p[A] + Z,\n                    AB = p[A + 1] + Z,\n                    B = p[X + 1] + Y,\n                    BA = p[B] + Z,\n                    BB = p[B + 1] + Z;\n                return lerp(w, lerp(v, lerp(u, grad(p[AA], x, y, z),\n                            grad(p[BA], xMinus1, y, z)),\n                        lerp(u, grad(p[AB], x, yMinus1, z),\n                            grad(p[BB], xMinus1, yMinus1, z))),\n                    lerp(v, lerp(u, grad(p[AA + 1], x, y, zMinus1),\n                            grad(p[BA + 1], xMinus1, y, z - 1)),\n                        lerp(u, grad(p[AB + 1], x, yMinus1, zMinus1),\n                            grad(p[BB + 1], xMinus1, yMinus1, zMinus1))));\n\n            }\n        };\n    }\n\n    function getRandomRange(min, max, allowNegatives) {\n        var n = -1 + Math.random() * 2;\n        var a = Math.abs(n);\n        var s = allowNegatives ? Math.floor(n / a) : 1;\n        return s * (min + (max - min) * a);\n    }\n\n    app.service('AnalyserService', ['$rootScope', '$q', '$http', 'SceneOptions', 'StepperService', function($rootScope, $q, $http, SceneOptions, StepperService) {\n\n        var service = this;\n        var options = SceneOptions;\n        var stepper = StepperService;\n\n        var analyser, audio, audioUrl;\n\n        function init() {\n            var source, ctx, actx = (window.AudioContext || window.webkitAudioContext);\n            source = null;\n            ctx = new actx();\n            analyser = ctx.createAnalyser();\n            audio = new Audio();\n            // audio.controls = true;\n            audio.addEventListener('canplay', function() {\n                var bufferLength;\n                console.log('audio canplay');\n                source = ctx.createMediaElementSource(audio);\n                source.connect(analyser);\n                source.connect(ctx.destination);\n                analyser.fftSize = options.bands * 2;\n                bufferLength = analyser.frequencyBinCount;\n                service.data = new Uint8Array(bufferLength);\n                // console.log('bufferLength', bufferLength);\n                return service.data;\n            });\n            setStep();\n        }\n\n        function setAudioUrl($audioUrl) {\n            if (audioUrl !== $audioUrl) {\n                audioUrl = $audioUrl;\n                audio.src = $audioUrl;\n                audio.volume = options.audioVolume;\n                audio.play();\n            }\n        }\n\n        function play() {\n            if (audio) {\n                audio.play();\n            }\n        }\n\n        function pause() {\n            if (audio) {\n                audio.pause();\n            }\n        }\n\n        function toggle() {\n            if (audio) {\n                service.active = !service.active;\n                if (service.active) {\n                    audio.play();\n                } else {\n                    audio.pause();\n                }\n            }\n        }\n\n        function setStep() {\n            var step = stepper.getCurrentStep();\n            setAudioUrl(step.audio.url);\n        }\n\n        function update() {\n            if (service.data) {\n                analyser.getByteFrequencyData(service.data);\n            }\n        }\n\n        $rootScope.$on('onStepChanged', function($scope) {\n            setStep();\n        });\n\n        $rootScope.$on('onOptionsChanged', function($scope) {\n            if (audio) {\n                audio.volume = options.audioVolume;\n            }\n        });\n\n        this.active = true;\n        this.audio = audio;\n        this.data = null;\n        this.init = init;\n        this.update = update;\n        this.play = play;\n        this.pause = pause;\n        this.toggle = toggle;\n\n    }]);\n\n    app.directive('scene', ['SceneOptions', 'StepperService', 'AnalyserService', function(SceneOptions, StepperService, AnalyserService) {\n        return {\n            restrict: 'A',\n            scope: {\n                data: '=scene',\n            },\n            link: function(scope, element, attributes) {\n                var data = scope.data;\n                if (!data) {\n                    return;\n                }\n\n                var objects = data.objects;\n\n                var options = SceneOptions;\n                var stepper = StepperService;\n                var analyser = AnalyserService;\n\n                options.noiseMap = getPerlinNoise(options.points, options.lines);\n\n                var stats, scene, camera, shadow, back, light, renderer, width, height, w2, h2;\n                var controls = null;\n\n                scope.$on('onStepChanged', function($scope, step) {\n                    console.log('onStepChanged', step.current);\n                    var circle = null;\n                    var current = step.current,\n                        previous = step.previous;\n                    if (current > 0) {\n                        circle = objects.circles[current] || getObjectCircles(current);\n                        circle.add();\n                    }\n                    objects.circles[current] = circle;\n                    setTimeout(function() {\n                        if (stepper.current !== previous && previous > 0) {\n                            var circle = objects.circles[previous];\n                            if (circle) {\n                                circle.remove();\n                            }\n                        }\n                    }, stepper.duration * 1000);\n                    console.log('objects', objects);\n                });\n\n                scope.$on('onOptionsChanged', function($scope) {\n                    // renderer.setClearColor(stepper.values.background, 1);\n                    if (objects.ribbon) {\n                        objects.ribbon.updateMaterial();\n                    }\n                    angular.forEach(objects.circles, function(circle) {\n                        if (circle) {\n                            circle.updateMaterial();\n                        }\n                    });\n                });\n\n                createScene();\n                // createLights();\n                createObjects();\n                addListeners();\n                loop();\n                analyser.init();\n\n                function createScene() {\n                    width = window.innerWidth;\n                    height = window.innerHeight;\n                    w2 = width / 2;\n                    h2 = height / 2;\n\n                    var ratio = width / height;\n                    var fov = 30;\n                    var near = 0.001;\n                    var far = 20000;\n\n                    scene = new THREE.Scene();\n                    // scene.fog = new THREE.Fog(0x000000, 300, 1000);\n\n                    camera = new THREE.PerspectiveCamera(fov, ratio, near, far);\n                    /*\n                    camera.position.z = 100;\n                    camera.position.y = -500;\n                    camera.lookAt(new THREE.Vector3(0, 0, 0));\n                    */\n\n                    renderer = new THREE.WebGLRenderer({\n                        alpha: true,\n                        antialias: true,\n                        logarithmicDepthBuffer: true\n                    });\n\n                    renderer.setClearColor(0x000000, 0); // the default\n                    // renderer.setClearColor(stepper.values.background, 1);\n                    renderer.setSize(width, height);\n                    // renderer.shadowMap.enabled = true;\n\n                    stats = new Stats();\n                    element[0].appendChild(renderer.domElement);\n                    element[0].appendChild(stats.dom);\n                }\n\n                function createLights() {\n                    light = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.5);\n                    shadow = new THREE.DirectionalLight(0xffffff, 0.8);\n                    shadow.position.set(200, 200, 200);\n                    shadow.castShadow = true;\n                    // shadow.shadowDarkness = .2;\n                    back = new THREE.DirectionalLight(0xffffff, 0.4);\n                    back.position.set(-100, 200, 50);\n                    // back.shadowDarkness = .2;\n                    back.castShadow = true;\n                    scene.add(light);\n                    scene.add(shadow);\n                    scene.add(back);\n                }\n\n                function createObjects() {\n                    objects.ribbon = getObjectRibbon();\n                    objects.circles = new Array(stepper.steps).fill(null);\n                }\n\n                function getObjectRibbon() {\n                    var material = getMaterial();\n\n                    var prev = new THREE.Vector3();\n                    var points = new Array(options.ribbon.points).fill(null).map(function() {\n                        var p = new THREE.Vector3().copy(prev);\n                        prev.x += getRandomRange(500, 1000, true);\n                        prev.y += getRandomRange(5, 20, true);\n                        prev.z += getRandomRange(1000, 2000, false);\n                        return p;\n                    });\n\n                    var spline = new THREE.CatmullRomCurve3(points);\n                    spline.type = 'catmullrom';\n                    spline.closed = false;\n\n                    var cameraSpline = new THREE.CatmullRomCurve3(spline.points.map(function(p) {\n                        return new THREE.Vector3(p.x, p.y + 20, p.z);\n                    }));\n                    cameraSpline.type = 'catmullrom';\n                    cameraSpline.closed = false;\n\n                    var geometry = new THREE.Geometry();\n                    geometry.vertices = spline.getPoints(options.ribbon.vertices);\n\n                    var line = new MeshLine();\n                    line.setGeometry(geometry);\n\n                    // line.setGeometry( geometry, function( p ) { return 2; } ); // makes width 2 * lineWidth\n                    // line.setGeometry( geometry, function( p ) { return 1 - p; } ); // makes width taper\n                    // line.setGeometry( geometry, function( p ) { return 2 + Math.sin( 50 * p ); } ); // makes width sinusoidal\n\n                    var object = new THREE.Mesh(line.geometry, material);\n                    add();\n\n                    function add() {\n                        console.log('objects.ribbon.add');\n                        scene.add(object);\n                    }\n\n                    function remove() {\n                        console.log('objects.ribbon.remove');\n                        scene.remove(object);\n                    }\n\n                    camera.target = camera.target || new THREE.Vector3(0, 0, 0);\n\n                    function updateRibbon() {\n                        var c = (1 / stepper.steps.length) * 0.1;\n                        var cpow = stepper.values.pow;\n                        var tpow = (cpow + c).mod(1);\n                        var step = stepper.getCurrentStep();\n                        var position = cameraSpline.getPointAt(cpow);\n                        position.y += stepper.values.cameraHeight;\n                        var target = cameraSpline.getPointAt(tpow);\n                        target.y += stepper.values.targetHeight;\n                        // var tangent = cameraSpline.getTangent(tpow).normalize().multiplyScalar(100);\n                        // target.add(tangent);\n                        camera.position.copy(position);\n                        camera.target.copy(target);\n                        camera.lookAt(camera.target);\n                    }\n\n                    function getMaterial() {\n                        var resolution = new THREE.Vector2(window.innerWidth, window.innerHeight);\n                        return new MeshLineMaterial({\n                            color: stepper.values.lines,\n                            lineWidth: 5,\n                            depthTest: true,\n                            /*\n                            opacity: 1,\n                            resolution: resolution,\n                            sizeAttenuation: 1,\n                            near: 1,\n                            far: 1000,\n                            blending: THREE.AdditiveBlending,\n                            transparent: false,\n                            side: THREE.DoubleSide,\n                            */\n                        });\n                    }\n\n                    function updateRibbonMaterial() {\n                        // !!! non va bene\n                        objects.ribbon.material = getMaterial();\n                        objects.ribbon.object.material = objects.ribbon.material;\n                    }\n\n                    return {\n                        object: object,\n                        spline: spline,\n                        cameraSpline: cameraSpline,\n                        geometry: geometry,\n                        material: material,\n                        add: add,\n                        remove: remove,\n                        update: updateRibbon,\n                        updateMaterial: updateRibbonMaterial,\n                    };\n                }\n\n                function getObjectCircles(index) {\n                    var geometry, object, circles = [];\n\n                    // materials\n                    var material1 = new THREE.LineBasicMaterial({\n                        color: stepper.values.lines,\n                    });\n\n                    var material2 = new THREE.LineBasicMaterial({\n                        color: stepper.values.overLines,\n                    });\n\n                    var resolution = new THREE.Vector2(window.innerWidth, window.innerHeight);\n\n                    object = new THREE.Object3D();\n\n                    var points1 = [],\n                        points2 = [],\n                        meshLines1 = [],\n                        meshLines2 = [],\n                        meshLineGeometries1 = [],\n                        meshLineGeometries2 = [],\n                        useMeshLines = false;\n\n                    var pn = options.points,\n                        ln = options.lines;\n\n                    var dummy = new THREE.Object3D();\n                    object.add(dummy);\n\n                    // circle\n                    var step = stepper.steps[index];\n                    var texture = new THREE.TextureLoader().load(step.circle.texture);\n                    texture.wrapS = THREE.RepeatWrapping;\n                    texture.wrapT = THREE.RepeatWrapping;\n                    texture.repeat.set(1, 1);\n                    var material = new THREE.MeshBasicMaterial({\n                        color: 0xffffff,\n                        map: texture,\n                        transparent: true,\n                    });\n                    geometry = new THREE.PlaneGeometry(options.radius * 2 - 20, options.radius * 2 - 20, 8, 8);\n                    var plane = new THREE.Mesh(geometry, material);\n                    dummy.add(plane);\n                    // circle\n\n                    var group1 = new THREE.Object3D();\n                    dummy.add(group1);\n\n                    var group2 = new THREE.Object3D();\n                    dummy.add(group2);\n\n                    var lines1 = new Array(ln).fill(null).map(getLine1);\n                    var lines2 = new Array(ln).fill(null).map(getLine2);\n\n                    var state = {\n                        pow: 0,\n                        duration: 0.350,\n                        enabled: false,\n                        adding: false,\n                        removing: false,\n                    };\n\n                    var to = null;\n\n                    function add() {\n                        console.log('objects.circles.add');\n                        scene.add(object);\n                        state.adding = Date.now();\n                        state.removing = false;\n                        state.enabled = true;\n                        if (state.tween) {\n                            state.tween.kill();\n                        }\n                        state.tween = TweenLite.to(state, state.duration, {\n                            pow: 1,\n                            delay: 0,\n                            ease: Power2.easeInOut,\n                            onComplete: function() {\n                                state.adding = false;\n                            },\n                        });\n                    }\n\n                    function remove() {\n                        console.log('objects.circles.remove');\n                        state.adding = false;\n                        state.removing = Date.now();\n                        if (state.tween) {\n                            state.tween.kill();\n                        }\n                        state.tween = TweenLite.to(state, state.duration, {\n                            pow: 0,\n                            delay: 0,\n                            ease: Power2.easeInOut,\n                            onComplete: function() {\n                                state.removing = false;\n                                state.enabled = false;\n                                scene.remove(object);\n                            },\n                        });\n                    }\n\n                    var iterator = 0;\n\n                    function getLine1(v, i) {\n                        var geometry = new THREE.Geometry();\n                        var points = addPoints(geometry, i, 1);\n                        var line = null;\n                        line = new THREE.LineLoop(geometry, material1);\n                        points1.push(points);\n                        // var spline = new THREE.CatmullRomCurve3(points);\n                        // circle.spline = spline;\n                        group1.add(line);\n                        return line;\n                    }\n\n                    function getLine2(v, i) {\n                        var geometry = new THREE.Geometry();\n                        var points = addPoints(geometry, i, 2);\n                        var line = null;\n                        line = new THREE.LineLoop(geometry, material2);\n                        points2.push(points);\n                        // var spline = new THREE.CatmullRomCurve3(points);\n                        // circle.spline = spline;\n                        group2.add(line);\n                        return line;\n                    }\n\n                    function addPoints(geometry, l, g) {\n                        var points = new Array(pn).fill(null).map(function(v, i) {\n                            var ratio = i / pn;\n                            var degrees = 360 * ratio; // point degrees;\n                            degrees += 60 * index; // circle offset;\n                            degrees += 30 * g; // group offset;\n                            degrees += (360 / pn * 0.1) * l; // line offset;\n                            var radians = degrees * Math.PI / 180;\n                            var radius = options.radius;\n                            var increment = 0;\n                            if (g === 1) {\n                                increment += (l * l * l * 0.005);\n                            } else {\n                                increment += (l * l * l * 0.005);\n                            }\n                            v = new THREE.Vector3();\n                            v.sincos = {\n                                base: radius,\n                                increment: increment,\n                                radius: radius,\n                                x: Math.cos(radians),\n                                y: Math.sin(radians),\n                            };\n                            geometry.vertices.push(v);\n                            return v;\n                        });\n                        return points;\n                    }\n\n                    function updateLine(geometry, vertices, l, g) {\n                        var audioStrength = options.audioStrength,\n                            noiseStrength = options.noiseStrength,\n                            circularStrength = options.circularStrength,\n                            data = analyser.data;\n\n                        angular.forEach(vertices, function(v, i) {\n                            var aia = i % options.bands;\n                            var aib = (pn - 1 - i) % options.bands;\n                            var audioPow = data ? ((data[aia] + data[aib]) / 2) / options.bands : 0;\n                            // var audioPow = data[aia] / options.bands;\n\n                            var nd = g === 1 ? 0 : 64;\n                            var nia = l * pn + ((i + nd + iterator) % pn);\n                            var nib = l * pn + (((pn - 1 - i - nd) + iterator) % pn);\n                            var noisePow = (options.noiseMap[nia] + options.noiseMap[nib]) / 2 / 64;\n\n                            var linePow = 1 - ((ln - l) / ln * circularStrength);\n\n                            var radius = v.sincos.base +\n                                (v.sincos.increment * noisePow) +\n                                (v.sincos.increment * audioPow) +\n                                (noiseStrength * noisePow) * linePow +\n                                (audioStrength * audioPow) * linePow +\n                                // (audioStrength * (3 - g) * audioPow * (l * 0.1)) * linePow +\n                                0;\n\n                            v.sincos.radius = radius;\n                            // v.sincos.radius += (radius - v.sincos.radius) / 2;\n\n                            v.x = v.sincos.x * v.sincos.radius;\n                            v.y = v.sincos.y * v.sincos.radius;\n                            v.z = 0; // -l;\n                            // console.log(v.sincos.radius);\n                        });\n\n                        /*\n                        var f = 0;\n                        var l = pn - 1;\n                        var first = new THREE.Vector3().copy(vertices[f]);\n                        var last = new THREE.Vector3().copy(vertices[l]);\n                        vertices[f].add(new THREE.Vector3().subVectors(first, last).multiplyScalar(0.5));\n                        vertices[l].add(new THREE.Vector3().subVectors(first, last).multiplyScalar(-0.5));\n                        */\n\n                        geometry.verticesNeedUpdate = true;\n\n                        /*\n                                    lines.forEach( function( l, i ) {\n                        if( params.animateWidth ) l.material.uniforms.lineWidth.value = params.lineWidth * ( 1 + .5 * Math.sin( 5 * t + i ) );\n                        if( params.autoRotate ) l.rotation.y += .125 * delta;\n                      l.material.uniforms.visibility.value= params.animateVisibility ? (time/3000) % 1.0 : 1.0;\n                                */\n                        /*\n                        if (iterator === 60 && g === 2 && l === 0) {\n                            console.log('vertices', geometry.vertices.map(function(v) { return v.x + ',' + v.y; }));\n                        }\n                        */\n                    }\n\n                    function updateCircle() {\n                        angular.forEach(lines1, function(line, l) {\n                            updateLine(line.geometry, points1[l], l, 1);\n                        });\n\n                        angular.forEach(lines2, function(line, l) {\n                            updateLine(line.geometry, points2[l], l, 2);\n                        });\n\n                        group1.rotation.z += 0.001;\n                        group2.rotation.z -= 0.001;\n\n                        var step = stepper.getStepAtIndex(index);\n                        dummy.position.copy(step.circle.position);\n\n                        var position = objects.ribbon.cameraSpline.getPointAt((index + 0.1) / stepper.steps.length);\n                        // var tangent = objects.ribbon.cameraSpline.getTangent(index + 0.1 / stepper.steps.length).normalize().multiplyScalar(300);\n                        // position.add(tangent);\n\n                        position.y += stepper.values.targetHeight;\n                        object.position.copy(position);\n\n                        /*\n                        object.position.x += (position.x + Math.random() * 20 - object.position.x) / 20;\n                        object.position.y += (position.y + Math.random() * 20 - object.position.y) / 20;\n                        object.position.z += (position.z + Math.random() * 20 - object.position.z) / 20;\n                        */\n\n                        object.scale.x = object.scale.y = object.scale.z = 0.001 + 0.1 * state.pow;\n                        object.lookAt(camera.position);\n\n                        updateCircleMaterial();\n\n                        // iterator++;\n                    }\n\n                    function updateCircleMaterial() {\n                        material1.color = stepper.values.lines;\n                        material2.color = stepper.values.overLines;\n                    }\n\n                    return {\n                        add: add,\n                        remove: remove,\n                        object: object,\n                        state: state,\n                        update: updateCircle,\n                        updateMaterial: updateCircleMaterial,\n                    };\n                }\n\n                function render() {\n                    analyser.update();\n                    if (controls) {\n                        controls.update();\n                    }\n                    if (objects.ribbon) {\n                        objects.ribbon.update();\n                    }\n                    angular.forEach(objects.circles, function(circle) {\n                        if (circle && circle.state.enabled) {\n                            circle.update();\n                        }\n                    });\n                    renderer.render(scene, camera);\n                }\n\n                function loop() {\n                    stats.begin();\n                    render();\n                    stats.end();\n                    requestAnimationFrame(loop);\n                }\n\n                // var mouse = { x: 0, y: 0 };\n                // var mousePos = { x: 0, y: 0 };\n\n                function addListeners() {\n                    function onWindowResize() {\n                        width = window.innerWidth;\n                        height = window.innerHeight;\n                        w2 = width / 2;\n                        h2 = height / 2;\n                        renderer.setSize(width, height);\n                        camera.aspect = width / height;\n                        camera.updateProjectionMatrix();\n                    }\n                    window.addEventListener('resize', onWindowResize, false);\n                    /*\n                    function handleMouseMove(event) {\n                        mouse = { x: event.clientX, y: event.clientY };\n                    }\n\n                    function handleMouseDown(event) {\n                        //\n                    }\n\n                    function handleMouseUp(event) {\n                        //\n                    }\n\n                    function handleTouchStart(event) {\n                        if (event.touches.length > 1) {\n                            event.preventDefault();\n                            mousePos = { x: event.touches[0].pageX, y: event.touches[0].pageY };\n                        }\n                    }\n\n                    function handleTouchEnd(event) {\n                        mousePos = { x: windowHalfX, y: windowHalfY };\n                    }\n\n                    function handleTouchMove(event) {\n                        if (event.touches.length == 1) {\n                            event.preventDefault();\n                            mousePos = { x: event.touches[0].pageX, y: event.touches[0].pageY };\n                        }\n                    }\n                    */\n                    /*\n                    document.addEventListener('mousemove', handleMouseMove, false);\n                    document.addEventListener('mousedown', handleMouseDown, false);\n                    document.addEventListener('mouseup', handleMouseUp, false);\n                    document.addEventListener('touchstart', handleTouchStart, false);\n                    document.addEventListener('touchend', handleTouchEnd, false);\n                    document.addEventListener('touchmove', handleTouchMove, false);\n                    */\n                }\n\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('slickBackgrounds', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function unSlick() {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('unslick');\n                    }\n                }\n\n                function onSlick() {\n                    unSlick();\n                    element.slick({\n                        arrows: false,\n                        dots: false,\n                        fade: true,\n                        speed: 1100,\n                        infinite: false,\n                        lazyLoad: 'ondemand',\n                        cssEase: 'cubic-bezier(0.7, 0, 0.3, 1)'\n                    });\n                }\n\n                scope.$watchCollection(attributes.slickBackgrounds, function(items) {\n                    if (items && items.length) {\n                        onSlick();\n                    }\n                });\n\n                scope.$on('$destroy', function() {\n                    unSlick();\n                });\n            }\n        };\n    }]);\n\n    app.directive('slickTunnel', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function unSlick() {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('unslick');\n                    }\n                }\n\n                function onSlick() {\n                    unSlick();\n                    element.slick({\n                        arrows: false,\n                        dots: false,\n                        fade: true,\n                        speed: 1100,\n                        infinite: false,\n                        draggable: false,\n                        asNavFor: '.tunnel-bg',\n                        cssEase: 'cubic-bezier(0.7, 0, 0.3, 1)'\n                    });\n                }\n\n                scope.$watchCollection(attributes.slickTunnel, function(items) {\n                    if (items && items.length) {\n                        onSlick();\n                    }\n                });\n\n                var tunnelAnimating = false;\n\n                function onInit() {\n                    var letters = $('.slick-active .splitted-letter');\n                    TweenMax.staggerTo(letters, 1, {\n                        delay: 0.2,\n                        y: 0,\n                        x: 0,\n                        ease: Power3.easeInOut,\n                        className: '+=viewed',\n                        onComplete: function() {\n                            $('.slick-active .cta').addClass('active');\n                        }\n                    }, 0.009);\n                }\n\n                function onBeforeChange(event, slick, currentSlide, nextSlide) {\n                    tunnelAnimating = true;\n                    var letters = $('.slick-active .splitted-letter');\n                    TweenMax.staggerTo(letters, 1, { delay: 0, y: 100, x: 50, ease: Power3.easeInOut, className: '-=viewed' }, 0.009);\n                    $('.slick-active .cta').removeClass('active');\n                    /*\n                    var $next = $(slick.$slides.get(nextSlide)).find('.tunnel-slick__item');\n                    var from = $next.attr('data-from');\n                    var to = $next.attr('data-to');\n                    changeYear(from, to);\n                    var bg = $next.attr('data-bg');\n                    $('body').removeClass('light-bg dark-bg');\n                    $('body').addClass(bg + '-bg');\n                    switchScene(nextSlide);\n                    */\n                    scope.$root.$broadcast('onSlickBeforeChange', { current: nextSlide, previouse: currentSlide });\n                }\n\n                function onAfterChange() {\n                    tunnelAnimating = false;\n                    var letters = $('.slick-active .splitted-letter');\n                    TweenMax.staggerTo(letters, 1, {\n                        delay: 0.2,\n                        y: 0,\n                        x: 0,\n                        ease: Power3.easeInOut,\n                        className: '+=viewed',\n                        onComplete: function() {\n                            $('.slick-active .cta').addClass('active');\n                        }\n                    }, 0.009);\n                    scope.$root.$broadcast('onAfterChange');\n                }\n\n                function onWheel(e) {\n                    if (tunnelAnimating) {\n                        return;\n                    }\n                    if (element.hasClass('slick-initialized')) {\n                        if (e.deltaX > 0 || e.deltaY < 0) {\n                            element.slick('slickNext');\n                        } else if (e.deltaX < 0 || e.deltaY > 0) {\n                            element.slick('slickPrev');\n                        }\n                    }\n                    e.preventDefault();\n                }\n\n                scope.$on('onGoStep', function($scope, index) {\n                    if (element.hasClass('slick-initialized')) {\n                        element.slick('slickGoTo', index);\n                    }\n                });\n\n                function addListeners() {\n                    element\n                        .on('init', onInit)\n                        .on('beforeChange', onBeforeChange)\n                        .on('afterChange', onAfterChange)\n                        .on('mousewheel', onWheel);\n                }\n\n                function removeListeners() {\n                    element\n                        .off('init', onInit)\n                        .off('beforeChange', onBeforeChange)\n                        .off('afterChange', onAfterChange)\n                        .off('mousewheel', onWheel);\n                }\n\n                addListeners();\n\n                scope.$on('$destroy', function() {\n                    removeListeners();\n                    unSlick();\n                });\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('splitText', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes) {\n\n                function splitText() {\n\n                    var nodes = element[0].childNodes;\n                    nodes = Array.prototype.slice.call(nodes, 0);\n\n                    element.html('').addClass('active');\n\n                    var rows = [\n                        []\n                    ];\n\n                    nodes.filter(function(node) {\n                        return node.nodeType === 3 || node.nodeType === 1;\n                    }).map(function(node) {\n                        if (node.nodeType === 3) {\n                            node = { text: $.trim(node.textContent), element: 'span' };\n                        } else {\n                            if (node.nodeName.toLowerCase() === 'br') {\n                                rows.push([]);\n                                return;\n                            }\n                            node = { text: $.trim(node.innerHTML), element: node.nodeName };\n                        }\n                        if (node.text !== '') {\n                            rows[rows.length - 1].push(node);\n                        }\n                    });\n\n                    for (var r = 0; r < rows.length; r++) {\n                        /* Riga */\n                        // console.log('riga ' + r, rows[r]);\n                        var row = rows[r];\n                        $('<div class=\"splitted-row\"></div>').appendTo(element);\n\n                        /* Elemento */\n                        for (var e = 0; e < row.length; e++) {\n                            var el = row[e];\n                            var type = el.element.toLowerCase();\n                            var text = el.text;\n                            // console.log('\\telemento ' + e, type, text);\n\n                            /* Parola */\n                            var words = text.split(' ');\n                            for (var w = 0; w < words.length; w++) {\n                                // console.log('\\t\\tword ' + w, words[w]);\n                                $('<' + type + ' class=\"splitted-word\"></' + type + '>').appendTo($('.splitted-row:last'), element);\n\n                                /* Lettera */\n                                var word = words[w];\n                                var letters = word.split('');\n                                for (var l = 0; l < letters.length; l++) {\n                                    // console.log('\\t\\t\\tlettera' + l, letters[l]);\n                                    var letter = letters[l];\n                                    $('<span class=\"splitted-letter\" data-content=\"' + letter + '\">' + letter + '</span>').appendTo($('.splitted-word:last'), element);\n                                }\n                                $('<span class=\"splitted-space\">&nbsp;</span>').appendTo($('.splitted-word:last'), element);\n                            }\n                        }\n                    }\n                }\n\n                setTimeout(function() {\n                    splitText();\n                }, 1);\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.directive('yearsFrom', [function() {\n        return {\n            restrict: 'A',\n            scope: {\n                from: '=yearsFrom',\n                to: '=yearsTo',\n            },\n            link: function(scope, element, attributes) {\n\n                function onChangeYears() {\n\n                    console.log('onChangeYears', scope.from, scope.to);\n\n                    var yearFrom = element.find('.tunnel-year__from'),\n                        yearTo = element.find('.tunnel-year__to'),\n                        time = 2,\n                        easing = Power3.easeOut,\n                        years = {\n                            from: yearFrom.html(),\n                            to: yearTo.html()\n                        };\n\n                    if (scope.to) {\n                        element.removeClass('one-year');\n                        TweenLite.to(years, time, { to: scope.to, roundProps: 'year', onUpdate: updateYear, ease: easing });\n                    } else {\n                        element.addClass('one-year');\n                        TweenLite.to(years, time, { to: scope.from, roundProps: 'year', onUpdate: updateYear, ease: easing });\n                    }\n\n                    TweenLite.to(years, time, { from: scope.from, roundProps: 'year', onUpdate: updateYear, ease: easing });\n\n                    function updateYear() {\n                        yearFrom.html(parseInt(years.from));\n                        yearTo.html(parseInt(years.to));\n                    }\n                }\n\n                scope.$watch('from', function(newValue, oldValue) {\n                    if (newValue) {\n                        onChangeYears();\n                    }\n                });\n\n            }\n        };\n    }]);\n\n}());\n/* global angular */\n\n(function() {\n    \"use strict\";\n\n    var app = angular.module('app');\n\n    app.constant('SceneOptions', {\n        colors: {\n            background: 0xeae8e8,\n            lines: 0xb4bfdd,\n            overLines: 0x3353a4,\n        },\n        camera: {\n            cameraHeight: 0,\n            targetHeight: 5,\n        },\n        circle: {\n            position: new THREE.Vector3(),\n        },\n        ribbon: {\n            steps: 12,\n            points: 24, // 12\n            vertices: 2400, // 1200\n        },\n        audioVolume: 0.9,\n        bands: 128,\n        points: 128,\n        lines: 32,\n        radius: 200,\n        audioStrength: 100,\n        noiseStrength: 25,\n        circularStrength: 0.90,\n    });\n\n    app.controller('RootCtrl', ['$scope', 'SceneOptions', 'StepperService', 'AnalyserService', 'DatGui', function($scope, SceneOptions, StepperService, AnalyserService, DatGui) {\n\n        var scene = {\n            objects: {},\n            options: SceneOptions,\n            stepper: StepperService,\n        };\n\n        var objects = scene.objects;\n        var options = scene.options;\n        var stepper = scene.stepper;\n\n        stepper.init().then(function() {\n            $scope.scene = scene;\n            $scope.stepper = stepper;\n            $scope.audio = AnalyserService;\n            var gui = new DatGui();\n        });\n\n    }]);\n\n    app.service('StepperService', ['$rootScope', '$timeout', '$q', '$http', '$sce', 'SceneOptions', function($rootScope, $timeout, $q, $http, $sce, SceneOptions) {\n\n        var stepper = this;\n        var options = SceneOptions;\n\n        var current = 0;\n        var duration = 2.500; // sec\n        var steps = [];\n        var tweens = [];\n\n        var values = {\n            pow: 0,\n            background: new THREE.Color(options.colors.background),\n            lines: new THREE.Color(options.colors.lines),\n            overLines: new THREE.Color(options.colors.overLines),\n            cameraHeight: options.camera.cameraHeight,\n            targetHeight: options.camera.targetHeight,\n        };\n\n        function getItems() {\n            var titles = [\n                'Il periodo francese:<br> la nascita della <em>Grand Opéra</em>',\n                'Il Barbiere di Siviglia<br> al teatro Argentina<br> di Roma',\n                'Il Silenzio',\n            ];\n            var audioTitles = [\n                'Il Barbiere di Siviglia',\n                'L\\'italiana in Algeri',\n            ];\n            var audios = [\n                'audio/07-rossini-192.mp3',\n                'audio/08-rossini-192.mp3',\n            ];\n            var backgrounds = [\n                'img/tunnel-1.jpg',\n                'img/tunnel-2.jpg',\n                'img/tunnel-3.jpg',\n            ];\n            var contrasts = [\n                'light-bg',\n                'light-bg',\n                'dark-bg',\n            ];\n            var items = new Array(options.ribbon.steps).fill().map(function(v, i) {\n                return {\n                    id: i + 1,\n                    name: 'Step ' + (i + 1),\n                    title: titles[i % titles.length],\n                    chapter: 'Passione, Genio e Silenzio',\n                    paragraph: 'Sulle strade di Parigi',\n                    years: {\n                        from: 1812 + Math.round(Math.random() * 50),\n                        to: 1812 + Math.round(Math.random() * 50),\n                    },\n                    background: backgrounds[i % backgrounds.length],\n                    contrast: contrasts[i % contrasts.length],\n                    colors: angular.copy(SceneOptions.colors),\n                    camera: {\n                        cameraHeight: 0,\n                        targetHeight: 0,\n                    },\n                    circle: {\n                        position: new THREE.Vector3(0, 0, 0),\n                        texture: 'img/rossini-01.png',\n                    },\n                    audio: {\n                        url: audios[i % audios.length],\n                        title: audioTitles[i % audioTitles.length],\n                        orchestra: 'Academy of St Martin in the Fields Orchestra',\n                    },\n                };\n            });\n            return items;\n        }\n\n        function init() {\n            var deferred = $q.defer();\n            $http.get('json/rossini.js').then(function(response) {\n                // var items = response.data;\n                var items = getItems();\n                angular.forEach(items, function(item) {\n                    item.titleTrusted = $sce.trustAsHtml(item.title);\n                    item.circle.position = new THREE.Vector3().copy(item.circle.position);\n                    steps.push(item);\n                });\n                setStep(0);\n                console.log('StepperService.load', steps);\n                deferred.resolve(steps);\n\n            }, function(error) {\n                deferred.reject(error);\n\n            });\n            return deferred.promise;\n        }\n\n        function clearTweens() {\n            while (tweens.length) {\n                var tween = tweens.pop();\n                tween.kill();\n            }\n        }\n\n        function tweenTo(pow, step, duration, callback) {\n            clearTweens();\n            var background = new THREE.Color(step.colors.background);\n            var lines = new THREE.Color(step.colors.lines);\n            var overLines = new THREE.Color(step.colors.overLines);\n            tweens.push(TweenLite.to(stepper.values, duration, {\n                pow: pow,\n                cameraHeight: step.camera.cameraHeight,\n                targetHeight: step.camera.targetHeight,\n                delay: 0,\n                ease: Power2.easeInOut,\n                onComplete: function() {\n                    if (callback) {\n                        callback();\n                    }\n                },\n            }));\n            tweens.push(TweenLite.to(stepper.values.background, duration, {\n                r: background.r,\n                g: background.g,\n                b: background.b,\n                delay: 0,\n                ease: Power2.easeInOut,\n                onUpdate: function() {\n                    var color = stepper.values.background.getHexString();\n                    document.body.style.backgroundColor = '#' + color;\n                }\n            }));\n            tweens.push(TweenLite.to(stepper.values.lines, duration, {\n                r: lines.r,\n                g: lines.g,\n                b: lines.b,\n                delay: 0,\n                ease: Power2.easeInOut,\n            }));\n            tweens.push(TweenLite.to(stepper.values.overLines, duration, {\n                r: overLines.r,\n                g: overLines.g,\n                b: overLines.b,\n                delay: 0,\n                ease: Power2.easeInOut,\n            }));\n        }\n\n        function setTweens(duration) {\n            var index = stepper.current;\n            var step = steps[index];\n            tweenTo(index / steps.length, step, duration, function() {\n                clearTweens();\n                console.log(step, stepper.values);\n            });\n        }\n\n        $rootScope.$on('onOptionsChanged', function() {\n            var index = stepper.current;\n            var step = steps[index];\n            stepper.values.cameraHeight = step.camera.cameraHeight;\n            stepper.values.targetHeight = step.camera.targetHeight;\n            stepper.values.background.copy(new THREE.Color(step.colors.background));\n            stepper.values.lines.copy(new THREE.Color(step.colors.lines));\n            stepper.values.overLines.copy(new THREE.Color(step.colors.overLines));\n            // setTweens(0.250);\n        });\n\n        $rootScope.$on('onSlickBeforeChange', function($scope, slick) {\n            setStep(slick.current);\n        });\n\n        function setStep(index) {\n            $timeout(function() {\n                var previous = stepper.current || 0;\n                stepper.current = index;\n                var step = steps[index];\n                stepper.step = step;\n                options.colors.background = step.colors.background;\n                options.colors.lines = step.colors.lines;\n                options.colors.overLines = step.colors.overLines;\n                options.camera.cameraHeight = step.camera.cameraHeight;\n                options.camera.targetHeight = step.camera.targetHeight;\n                options.circle.position.copy(step.circle.position);\n                $rootScope.$broadcast('onStepChanged', { current: index, previous: previous });\n                console.log('onStepChanged', index, step);\n                setTweens(stepper.duration);\n            });\n        }\n\n        function next() {\n            current++;\n            current = Math.min(steps.length - 1, current);\n            setStep(current);\n            $rootScope.$broadcast('onGoStep', current);\n        }\n\n        function previous() {\n            current--;\n            current = Math.max(0, current);\n            setStep(current);\n            $rootScope.$broadcast('onGoStep', current);\n        }\n\n        function getCurrentStep() {\n            return steps[current];\n        }\n\n        function getStepAtIndex(index) {\n            return steps[index];\n        }\n\n        this.init = init;\n        this.values = values;\n        this.duration = duration;\n        this.steps = steps;\n        this.current = current;\n        this.next = next;\n        this.previous = previous;\n        this.getCurrentStep = getCurrentStep;\n        this.getStepAtIndex = getStepAtIndex;\n\n    }]);\n\n    app.directive('scrollbar', [function() {\n        return {\n            restrict: 'A',\n            link: function(scope, element, attributes, model) {\n                var native = element[0];\n                var options = {\n                    speed: 1,\n                    damping: 0.1,\n                    overscrollDamping: 1.0,\n                    thumbMinSize: 20,\n                    continuousScrolling: true,\n                    alwaysShowTracks: false\n                };\n\n                function Init() {\n                    var scrollbar = Scrollbar.init(native, options);\n                    console.log(scrollbar);\n                    scope.$watch(scrollbar.contentEl.offsetHeight, function(height) {\n                        scrollbar.update();\n                    });\n                }\n\n                setTimeout(Init, 100);\n            }\n        };\n    }]);\n\n}());"]}