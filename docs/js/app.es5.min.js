"use strict";(function(){var n=angular.module("app");n.constant("SceneOptions",{colors:{background:15395048,lines:11845597,overLines:3363748},camera:{cameraHeight:0,targetHeight:5},circle:{position:new THREE.Vector3},ribbon:{steps:12,points:24,vertices:2400},audioVolume:.9,bands:128,points:128,lines:32,radius:200,audioStrength:100,noiseStrength:25,circularStrength:.9});n.controller("RootCtrl",["$scope","SceneOptions","StepperService","AnalyserService","DatGui",function(n,t,i,r,u){var f={objects:{},options:t,stepper:i},o=f.objects,s=f.options,e=f.stepper;e.init().then(function(){n.scene=f;n.stepper=e;n.audio=r;var t=new u})}]);n.service("StepperService",["$rootScope","$timeout","$q","$http","$sce","SceneOptions",function(n,t,i,r,u,f){function y(){var n=["Il periodo francese:<br> la nascita della <em>Grand Opéra<\/em>","Il Barbiere di Siviglia<br> al teatro Argentina<br> di Roma","Il Silenzio"],t=["Il Barbiere di Siviglia","L'italiana in Algeri"],i=["audio/07-rossini-192.mp3","audio/08-rossini-192.mp3"],r=["img/tunnel-1.jpg","img/tunnel-2.jpg","img/tunnel-3.jpg"],u=["light-bg","light-bg","dark-bg"];return new Array(o.ribbon.steps).fill().map(function(e,o){return{id:o+1,name:"Step "+(o+1),title:n[o%n.length],chapter:"Passione, Genio e Silenzio",paragraph:"Sulle strade di Parigi",years:{from:1812+Math.round(Math.random()*50),to:1812+Math.round(Math.random()*50)},background:r[o%r.length],contrast:u[o%u.length],colors:angular.copy(f.colors),camera:{cameraHeight:0,targetHeight:0},circle:{position:new THREE.Vector3(0,0,0),texture:"img/rossini-01.png"},audio:{url:i[o%i.length],title:t[o%t.length],orchestra:"Academy of St Martin in the Fields Orchestra"}}})}function p(){var n=i.defer();return r.get("json/rossini.js").then(function(){var t=y();angular.forEach(t,function(n){n.titleTrusted=u.trustAsHtml(n.title);n.circle.position=(new THREE.Vector3).copy(n.circle.position);h.push(n)});l(0);console.log("StepperService.load",h);n.resolve(h)},function(t){n.reject(t)}),n.promise}function a(){while(c.length){var n=c.pop();n.kill()}}function w(n,t,i,r){a();var u=new THREE.Color(t.colors.background),f=new THREE.Color(t.colors.lines),o=new THREE.Color(t.colors.overLines);c.push(TweenLite.to(e.values,i,{pow:n,cameraHeight:t.camera.cameraHeight,targetHeight:t.camera.targetHeight,delay:0,ease:Power2.easeInOut,onComplete:function(){r&&r()}}));c.push(TweenLite.to(e.values.background,i,{r:u.r,g:u.g,b:u.b,delay:0,ease:Power2.easeInOut,onUpdate:function(){var n=e.values.background.getHexString();document.body.style.backgroundColor="#"+n}}));c.push(TweenLite.to(e.values.lines,i,{r:f.r,g:f.g,b:f.b,delay:0,ease:Power2.easeInOut}));c.push(TweenLite.to(e.values.overLines,i,{r:o.r,g:o.g,b:o.b,delay:0,ease:Power2.easeInOut}))}function b(n){var t=e.current,i=h[t];w(t/h.length,i,n,function(){a();console.log(i,e.values)})}function l(i){t(function(){var r=e.current||0,t;e.current=i;t=h[i];e.step=t;o.colors.background=t.colors.background;o.colors.lines=t.colors.lines;o.colors.overLines=t.colors.overLines;o.camera.cameraHeight=t.camera.cameraHeight;o.camera.targetHeight=t.camera.targetHeight;o.circle.position.copy(t.circle.position);n.$broadcast("onStepChanged",{current:i,previous:r});console.log("onStepChanged",i,t);b(e.duration)})}function k(){s++;s=Math.min(h.length-1,s);l(s);n.$broadcast("onGoStep",s)}function d(){s--;s=Math.max(0,s);l(s);n.$broadcast("onGoStep",s)}function g(){return h[s]}function nt(n){return h[n]}var e=this,o=f,s=0,h=[],c=[],v={pow:0,background:new THREE.Color(o.colors.background),lines:new THREE.Color(o.colors.lines),overLines:new THREE.Color(o.colors.overLines),cameraHeight:o.camera.cameraHeight,targetHeight:o.camera.targetHeight};n.$on("onOptionsChanged",function(){var t=e.current,n=h[t];e.values.cameraHeight=n.camera.cameraHeight;e.values.targetHeight=n.camera.targetHeight;e.values.background.copy(new THREE.Color(n.colors.background));e.values.lines.copy(new THREE.Color(n.colors.lines));e.values.overLines.copy(new THREE.Color(n.colors.overLines))});n.$on("onSlickBeforeChange",function(n,t){l(t.current)});this.init=p;this.values=v;this.duration=2.5;this.steps=h;this.current=s;this.next=k;this.previous=d;this.getCurrentStep=g;this.getStepAtIndex=nt}]);n.directive("scrollbar",[function(){return{restrict:"A",link:function(n,t){function u(){var t=Scrollbar.init(i,r);console.log(t);n.$watch(t.contentEl.offsetHeight,function(){t.update()})}var i=t[0],r={speed:1,damping:.1,overscrollDamping:1,thumbMinSize:20,continuousScrolling:!0,alwaysShowTracks:!1};setTimeout(u,100)}}}])})();